<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EspansoGUI</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0d1117;
            --surface: #161b22;
            --surface-alt: #0d1117;
            --border: #30363d;
            --text: #c9d1d9;
            --muted: #8b949e;
            --accent: #58a6ff;
            --code-bg: #21262d;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        body [style*="color: #8b949e"] { color: var(--muted) !important; }

        .sidebar {
            width: 220px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px 12px;
            gap: 8px;
        }
        .sidebar h1 {
            font-size: 18px;
            margin-bottom: 10px;
            padding: 0 4px;
        }
        .nav-btn {
            padding: 12px 14px;
            background: transparent;
            border: none;
            color: var(--text);
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
        }
        .nav-btn:hover { background: rgba(88, 166, 255, 0.12); }
        .nav-btn.active { background: #1f6feb; color: #fff; }
        .nav-subgroup {
            display: none;
            flex-direction: column;
            gap: 4px;
            margin-left: 10px;
            margin-top: 4px;
        }
        .nav-subgroup.open { display: flex; }
        .nav-btn.sub {
            font-size: 13px;
            padding: 8px 12px;
            background: rgba(19, 23, 32, 0.7);
        }
        .nav-btn.sub.active { background: #1f6feb; }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }
        .status-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.connected { background: #3fb950; }
        .status-indicator.disconnected { background: #f85149; }

        .view {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
            gap: 16px;
        }
        .view.active { display: flex; }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }
        .view-header .view-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .dash-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }
        .dash-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 18px;
        }
        .dash-card h3 {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 8px;
        }
        .dash-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #58a6ff;
        }
        .path-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-bottom: 16px;
        }
        .tree-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .tree-scroll {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 13px;
        }
        .tree-list {
            list-style: none;
            padding-left: 16px;
        }
        .tree-list li {
            margin: 4px 0;
        }
        .tree-node-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tree-node-label .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #30363d;
            color: #8b949e;
        }
        .override-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 14px 0;
        }
        .override-form input {
            flex: 1;
            min-width: 240px;
            padding: 10px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
        }
        .path-hint {
            font-size: 12px;
            color: #8b949e;
        }
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 14px;
        }
        .meta-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            font-size: 13px;
        }
        .meta-card h4 {
            margin-bottom: 8px;
            font-size: 13px;
            color: #8b949e;
        }

        .btn {
            background: #238636;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover { background: #2ea043; }
        .btn.secondary { background: #21262d; }
        .btn.secondary:hover { background: #30363d; }
        .btn.danger { background: #da3633; }
        .btn.danger:hover { background: #f85149; }
        .btn.small { padding: 6px 10px; font-size: 12px; }

        #yaml-editor {
            flex: 1;
            width: 100%;
            background: var(--surface-alt);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
        }

        .snippet-ide {
            flex: 1;
            display: grid;
            grid-template-columns: 1.4fr 0.6fr;
            gap: 20px;
            min-height: 0;
        }
        @media (max-width: 1280px) {
            .snippet-ide {
                grid-template-columns: 1fr;
            }
        }
        .snippet-editor, .snippet-panels {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            min-height: 0;
        }
        .surface-block {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            padding: 12px;
        }
        .scroll-block { overflow-y: auto; }
        .block-xl { min-height: 500px; max-height: calc(100vh - 240px); }
        .block-lg { min-height: 400px; max-height: calc(100vh - 300px); }
        .block-md { min-height: 300px; max-height: calc(100vh - 350px); }
        .block-sm { min-height: 200px; max-height: calc(100vh - 400px); }
        .code-block {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            color: var(--text);
        }
        .input-base {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface-alt);
            color: var(--text);
            font-size: 14px;
            width: 100%;
        }
        .code-chip {
            display: inline-block;
            background: var(--code-bg);
            color: var(--text);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            margin-right: 4px;
        }
        .card-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .flex-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        .field-stack {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .muted-text {
            color: var(--muted);
            font-size: 13px;
        }
        .match-result {
            font-weight: 600;
            margin-bottom: 8px;
        }
        .match-result.success { color: #3fb950; }
        .match-result.warn { color: #f85149; }
        .flex-1 { flex: 1; min-width: 0; }
        .flex-2 { flex: 2; min-width: 0; }
        .textarea-lg { min-height: 120px; resize: vertical; }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .panel-header h3 {
            font-size: 15px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .input-group label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .input-group input,
        .input-group textarea,
        .input-group select {
            padding: 10px 12px;
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
        }
        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #58a6ff;
        }
        .checkbox-row {
            display: flex;
            gap: 14px;
            padding: 10px 0;
            flex-wrap: wrap;
        }
        .checkbox-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #c9d1d9;
        }
        .replacement-editor {
            min-height: 220px;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.6;
        }
        .preview-pane {
            min-height: 220px;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.6;
            background: var(--surface-alt);
            border: 1px dashed var(--border);
            border-radius: 6px;
            padding: 12px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .cursor-marker {
            color: #f2cc60;
            font-weight: 600;
        }

        .snippet-list { max-height: calc(100vh - 400px); min-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .snippet-card {
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: border-color 0.2s ease;
            position: relative;
        }
        .snippet-card:hover { border-color: #58a6ff; }
        .snippet-card.active { border-color: #1f6feb; background: #1b2433; }
        .snippet-card.disabled { opacity: 0.7; }
        .selection-checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 5;
            background: rgba(13, 17, 23, 0.95);
            border-radius: 999px;
            padding: 3px 6px;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.35);
        }
        .selection-checkbox input {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
        .snippet-trigger {
            font-weight: 600;
            color: #58a6ff;
            margin-bottom: 4px;
        }
        .snippet-preview {
            color: #8b949e;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .snippet-meta {
            color: #6e7681;
            font-size: 11px;
            margin-top: 6px;
        }
        mark {
            background: rgba(241, 224, 90, 0.2);
            color: inherit;
            padding: 0 2px;
            border-radius: 3px;
        }

        .image-preview {
            border: 1px dashed var(--border);
            border-radius: 6px;
            background: var(--surface-alt);
            padding: 10px;
            min-height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 8px;
            color: var(--muted);
            font-size: 12px;
            transition: border-color 0.2s ease, background 0.2s ease;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 180px;
            border-radius: 4px;
        }
        .image-preview.drop-target {
            border-color: #58a6ff;
            background: #111a2a;
        }

        .dashboard-pre {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            min-height: 120px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            color: var(--text);
            white-space: pre-wrap;
            overflow-y: auto;
        }

        .snippetsense-toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1300;
        }
        .snippetsense-toast {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            width: min(360px, 90vw);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
            color: var(--text);
        }
        .snippetsense-toast strong {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .snippetsense-toast-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
        }

        .variable-list { display: flex; flex-direction: column; gap: 8px; }
        .variable-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .variable-info { font-size: 12px; }
        .variable-name { font-family: monospace; color: #58a6ff; }
        .variable-type { color: var(--muted); font-size: 11px; }
        .variable-actions { display: flex; gap: 6px; flex-wrap: wrap; }

        .quick-insert-search {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .quick-insert-search input {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface-alt);
            color: var(--text);
            font-size: 15px;
        }
        .quick-insert-layout {
            display: flex;
            gap: 16px;
            flex: 1;
            min-height: 0;
        }
        .quick-insert-results {
            flex: 2;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            overflow-y: auto;
            min-height: 0;
        }
        .quick-snippet-card {
            padding: 10px 6px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .quick-snippet-card:last-child { border-bottom: none; }
        .quick-snippet-card:hover { background: rgba(88, 166, 255, 0.12); }
        .quick-snippet-trigger {
            font-weight: 600;
            color: #58a6ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .quick-snippet-label {
            color: var(--muted);
            font-size: 12px;
        }
        .quick-snippet-meta {
            color: var(--muted);
            font-size: 11px;
            margin-top: 4px;
        }
        .quick-insert-preview {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface-alt);
            padding: 16px;
            min-height: 0;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            overflow-y: auto;
        }

        .variable-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        .variable-type-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
            background: var(--surface);
        }
        .variable-type-card h4 {
            font-size: 14px;
            color: var(--text);
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .variable-type-card span { font-size: 11px; color: var(--muted); }

        .global-vars-grid { display: flex; flex-direction: column; gap: 8px; }
        .global-var-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .helper-panel {
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-alt);
            padding: 12px;
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        .helper-panel.active { display: flex; }
        .helper-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .helper-panel .btn.small {
            flex: 1;
            min-width: 140px;
        }
        .helper-note {
            font-size: 12px;
            color: #8b949e;
        }

        .settings-layout {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }
        .settings-nav {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .settings-tab {
            padding: 10px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #161b22;
            color: #c9d1d9;
            text-align: left;
            cursor: pointer;
        }
        .settings-tab.active {
            background: #1f6feb;
            color: #fff;
            border-color: transparent;
        }
        .settings-pane-container {
            flex: 1;
            min-height: 0;
        }
        .settings-pane {
            display: none;
            flex-direction: column;
            gap: 16px;
            height: 100%;
        }
        .settings-pane.active { display: flex; }

        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px;
        }
        .help-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
        }
        .help-card h4 {
            margin-bottom: 6px;
            font-size: 15px;
            color: var(--accent);
        }
        .help-card ul {
            margin-left: 18px;
            color: var(--muted);
            font-size: 13px;
            line-height: 1.6;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            width: min(460px, 90%);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .modal-close {
            background: transparent;
            border: none;
            color: #8b949e;
            font-size: 26px;
            cursor: pointer;
        }
        .modal-close:hover { color: #fff; }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #238636;
            color: #fff;
            padding: 12px 18px;
            border-radius: 6px;
            display: none;
            z-index: 1200;
        }
        .toast.show { display: block; }
        .toast.error { background: #da3633; }

        /* Light theme */
        body.light-theme {
            --bg: #ffffff;
            --surface: #f6f8fa;
            --surface-alt: #ffffff;
            --border: #d0d7de;
            --text: #24292f;
            --muted: #57606a;
            --code-bg: #eaeef2;
        }
        body.light-theme .sidebar { background: var(--surface); border-right-color: var(--border); }
        body.light-theme .main { background: var(--bg); }
        body.light-theme .status-bar { background: var(--surface); border-bottom-color: var(--border); color: var(--text); }
        body.light-theme .nav-btn { color: var(--text); }
        body.light-theme .nav-btn:hover { background: #d0d7de; }
        body.light-theme .nav-btn.active { background: #0969da; color: #fff; }
        body.light-theme .dash-card, body.light-theme .modal-content, body.light-theme .snippet-card { background: var(--surface); border-color: var(--border); }
        body.light-theme input, body.light-theme textarea, body.light-theme select { background: var(--surface-alt); border-color: var(--border); color: var(--text); }
        body.light-theme .btn { background: #0969da; border-color: #0969da; }
        body.light-theme .btn.secondary, body.light-theme .btn-secondary { background: #6e7781; }
        body.light-theme .filter-group label { color: var(--text); }
        body.light-theme .selection-checkbox { background: rgba(255, 255, 255, 0.95); box-shadow: 0 0 4px rgba(0, 0, 0, 0.15); }
        body.light-theme .image-preview { background: var(--surface-alt); border-color: var(--border); color: var(--muted); }
        body.light-theme .image-preview.drop-target { background: #e7f3ff; border-color: #0969da; }
        body.light-theme .quick-snippet-card:hover { background: rgba(9, 105, 218, 0.1); }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>EspansoGUI</h1>
        <button class="nav-btn active" data-view="dashboard">Dashboard</button>
        <button class="nav-btn" data-view="editor">YAML Editor</button>
        <button class="nav-btn" data-view="snippet">Snippet IDE</button>
        <button class="nav-btn" data-view="snippet-library">Snippet Library</button>
        <button class="nav-btn" data-view="quick-insert">Quick Insert</button>
        <button class="nav-btn" data-view="variable-library">Variable Library</button>
        <button class="nav-btn" data-view="match-testing">Match Testing</button>
        <button class="nav-btn" data-view="forms-regex">Forms & Regex</button>
        <button class="nav-btn" data-view="snippetsense">SnippetSense</button>
        <button class="nav-btn" type="button" id="settings-toggle" aria-expanded="false">Settings & Tools ▸</button>
        <div class="nav-subgroup" id="settings-subnav">
            <button class="nav-btn sub" data-view="paths">Paths & Explorer</button>
            <button class="nav-btn sub" data-view="logs">Logs</button>
            <button class="nav-btn sub" data-view="packages">Packages</button>
            <button class="nav-btn sub" data-view="backup">Backup/Restore</button>
            <button class="nav-btn sub" data-view="doctor">Diagnostics</button>
            <button class="nav-btn sub" data-view="help">Help</button>
        </div>
        <button class="nav-btn" id="theme-toggle" style="margin-top: auto; opacity: 0.7;">Toggle Theme</button>
    </div>

    <div class="main">
        <div class="status-bar">
            <div>
                <span class="status-indicator" id="connection-indicator"></span>
                <span id="status-text">Connecting...</span>
            </div>
            <div id="snippet-count">0 snippets</div>
        </div>

        <div class="view active" id="dashboard-view">
            <h2 style="margin-bottom: 16px;">Espanso Control Panel</h2>
            <div class="dash-grid">
                <div class="dash-card">
                    <h3>Service Status</h3>
                    <div class="value" id="service-status">Unknown</div>
                </div>
                <div class="dash-card">
                    <h3>Snippets</h3>
                    <div class="value" id="total-snippets">0</div>
                </div>
                <div class="dash-card">
                    <h3>Config Path</h3>
                    <div class="value" id="config-path" style="font-size: 12px; word-break: break-all;">-</div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 8px;">Service Controls</h3>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn" id="btn-start" title="Start the Espanso background process">Start Espanso</button>
                    <button class="btn" id="btn-stop" title="Stop the Espanso background process">Stop Espanso</button>
                    <button class="btn" id="btn-restart" title="Restart Espanso to apply changes">Restart Espanso</button>
                    <button class="btn secondary" id="btn-refresh" title="Reload dashboard metrics">Refresh Data</button>
                </div>
            </div>
            <div style="margin-top: 24px;">
                <h3 style="margin-bottom: 8px;">Connection Steps</h3>
                <div id="connection-steps" style="font-size: 13px; color: #8b949e;"></div>
            </div>
            <div class="meta-grid" style="margin-top: 24px;">
                <div class="meta-card">
                    <h4>Recent Logs</h4>
                    <pre class="dashboard-pre" id="dashboard-log-preview">Logs will auto-populate after startup.</pre>
                </div>
                <div class="meta-card">
                    <h4>Diagnostics</h4>
                    <pre class="dashboard-pre" id="dashboard-diagnostic-preview">Diagnostics have not run yet.</pre>
                </div>
            </div>
        </div>

        <div class="view" id="editor-view">
            <h2 style="margin-bottom: 16px;">base.yml Editor</h2>
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap;">
                <button class="btn" id="btn-save-yaml">Save & Reload</button>
                <button class="btn secondary" id="btn-reload-yaml">Reload from Disk</button>
                <span id="editor-status" style="color: #8b949e;"></span>
            </div>
            <textarea id="yaml-editor" placeholder="Loading base.yaml..."></textarea>
        </div>

        <div class="view" id="snippet-view">
            <div class="view-header">
                <div>
                    <h2 style="margin-bottom: 4px;">Snippet & Variable IDE</h2>
                    <p class="muted-text">Create, preview, and manage your Espanso snippets from one place.</p>
                </div>
                <div class="view-actions">
                    <button class="btn" id="btn-new-snippet" title="Clear the form to start a new snippet">New Snippet</button>
                    <button class="btn secondary" id="btn-refresh-snippets" title="Reload snippets from disk">Refresh</button>
                </div>
            </div>
            <div class="snippet-ide">
                <div class="snippet-editor">
                    <div class="panel">
                        <div class="input-group" style="max-width: 320px;">
                            <label>Trigger</label>
                            <input type="text" id="snippet-trigger" placeholder=":example" autocomplete="off" title="The keyword that should trigger this snippet">
                        </div>
                        <div class="input-group" style="max-width: 320px;">
                            <label>Label</label>
                            <input type="text" id="snippet-label" placeholder="Customer support greeting" title="Optional description displayed in the library">
                        </div>
                        <div class="checkbox-row" title="Toggle snippet level metadata">
                            <label title="Disable to temporarily pause the snippet"><input type="checkbox" id="snippet-enabled" checked> Enabled</label>
                            <label title="Require whitespace boundaries"><input type="checkbox" id="snippet-word"> Word boundary</label>
                            <label title="Adjust output casing to match what you type"><input type="checkbox" id="snippet-propagate-case"> Propagate case</label>
                        </div>
                        <div class="checkbox-row" style="flex-wrap: wrap;" title="Fine tune boundary detection">
                            <label title="Require left boundary"><input type="checkbox" id="snippet-left-word"> Left word boundary</label>
                            <label title="Require right boundary"><input type="checkbox" id="snippet-right-word"> Right word boundary</label>
                        </div>
                        <div class="input-row" style="display:flex; gap:10px; flex-wrap:wrap;">
                            <div class="input-group" style="flex:1; min-width: 160px;">
                                <label>Backend</label>
                                <select id="snippet-backend" title="Select Inject (default) or Clipboard backend explicitly">
                                    <option value="">Auto</option>
                                    <option value="inject">Inject</option>
                                    <option value="clipboard">Clipboard</option>
                                </select>
                            </div>
                            <div class="input-group" style="width: 140px;">
                                <label>Delay (ms)</label>
                                <input type="number" id="snippet-delay" min="0" step="10" placeholder="0" title="Add delay before expansion (useful for slow applications)">
                            </div>
                            <div class="input-group" style="flex:1; min-width: 160px;">
                                <label>Uppercase Style</label>
                                <select id="snippet-uppercase-style" title="Force a specific case for the replacement">
                                    <option value="">Default</option>
                                    <option value="lowercase">Lowercase</option>
                                    <option value="uppercase">Uppercase</option>
                                    <option value="capitalize">Capitalize</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Image Path</label>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                                <input type="text" id="snippet-image-path" placeholder="C:\\Users\\you\\Pictures\\signature.png" style="flex: 1;" title="Absolute or relative path to an image file">
                                <button type="button" onclick="browseImagePath()" class="btn-secondary" style="white-space: nowrap;" title="Browse for an image file">Browse...</button>
                                <button type="button" onclick="validateImagePath()" class="btn-secondary" style="white-space: nowrap;" title="Validate and preview the current path">Test</button>
                                <button type="button" onclick="clearImagePath()" class="btn-secondary" style="white-space: nowrap;" title="Clear the image path">Clear</button>
                            </div>
                            <div id="snippet-image-preview" class="image-preview" title="Drag an image file here to populate the path">
                                <span>Drop an image or click Test to preview.</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Replacement</label>
                            <textarea id="snippet-replace" class="replacement-editor" placeholder="Type your replacement..." title="Body of the snippet. Use $|$ for cursor position and {{variable}} placeholders."></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn" id="btn-save-snippet" title="Save snippet and reload Espanso">Save Snippet</button>
                            <button class="btn secondary" id="btn-from-template" title="Apply one of the built-in snippet templates">From Template</button>
                            <button class="btn danger" id="btn-delete-snippet" title="Delete the currently loaded snippet">Delete</button>
                            <span id="snippet-status" style="color: #8b949e;"></span>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Variables</h3>
                            <button class="btn small" id="btn-add-var" title="Create a new local variable for this snippet">+ Add Variable</button>
                        </div>
                        <div class="variable-list" id="variable-list">
                            <p style="color: #8b949e; font-size: 13px;">No variables yet.</p>
                        </div>
                        <div style="margin-top: 14px;">
                            <h4 style="font-size: 13px; color: #8b949e; margin-bottom: 4px;">Variable Toolkit</h4>
                            <p class="path-hint">Pick a template to open the variable editor pre-configured for that type.</p>
                            <div class="variable-type-grid" id="variable-type-grid">
                                <p style="color: #8b949e; font-size: 13px;">Loading variable types...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="snippet-panels">
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Live Preview</h3>
                            <button class="btn small secondary" id="btn-insert-cursor" title="Insert $|$ at the current cursor position in the replacement body">Insert Cursor Marker</button>
                        </div>
                        <div class="preview-pane" id="snippet-preview">
                            <p style="color:#8b949e; font-size:13px;">Start typing to preview rich text output.</p>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Snippet Metadata</h3>
                        </div>
                        <div id="snippet-meta-summary" class="path-hint">No snippet selected.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view" id="snippet-library-view">
            <h2 style="margin-bottom: 16px;">Snippet Library</h2>
            <div class="panel">
                <div class="panel-header">
                    <h3>Snippets</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn small secondary" id="btn-bulk-enable" disabled title="Enable every selected snippet">Enable Selected</button>
                        <button class="btn small secondary" id="btn-bulk-disable" disabled title="Disable every selected snippet">Disable Selected</button>
                        <button class="btn small secondary" id="btn-export-selected" disabled title="Export selected snippets to a pack">Export Selected</button>
                        <button class="btn small secondary" id="btn-import-pack" title="Import snippets from a pack file">Import Pack</button>
                        <button class="btn small secondary" id="btn-refresh-snippet-library" title="Reload snippets from disk">Refresh</button>
                    </div>
                </div>
                <div class="filter-grid" style="display: flex; flex-direction: column; gap: 12px;">
                    <input type="text" class="search-input" id="snippet-search" placeholder="Search by trigger, replacement, or label...">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <select id="snippet-file-filter" class="search-input" style="max-width: 200px;">
                            <option value="">All files</option>
                        </select>
                        <select id="snippet-enabled-filter" class="search-input" style="max-width: 180px;">
                            <option value="">Any status</option>
                            <option value="enabled">Enabled only</option>
                            <option value="disabled">Disabled only</option>
                        </select>
                        <label class="path-hint" style="display:flex; align-items:center; gap:4px;">
                            <input type="checkbox" id="snippet-filter-vars"> Has variables
                        </label>
                        <label class="path-hint" style="display:flex; align-items:center; gap:4px;">
                            <input type="checkbox" id="snippet-filter-forms"> Has forms
                        </label>
                        <input type="text" class="search-input" id="snippet-label-filter" placeholder="Label contains..." style="max-width: 200px;">
                        <button class="btn small secondary" id="btn-clear-snippet-filters">Clear</button>
                    </div>
                </div>
                <div class="path-hint" id="snippet-search-summary">No snippets loaded.</div>
                <div class="snippet-list" id="snippet-list">
                    <p style="color: #8b949e; font-size: 13px;">Load snippets from the toolbar.</p>
                </div>
            </div>
        </div>

        <div class="view" id="quick-insert-view">
            <h2 style="margin-bottom: 12px;">Quick Insert</h2>
            <p class="path-hint" style="margin-bottom: 12px;">Find snippets fast, copy triggers to your clipboard, or jump directly into the editor without leaving this overlay.</p>
            <div class="quick-insert-search">
                <input type="search" id="quick-insert-input" placeholder="Search snippets by trigger, label, or body..." title="Type to filter snippets instantly">
                <button class="btn secondary" id="btn-clear-quick-insert" title="Clear the current quick search">Clear</button>
            </div>
            <div class="quick-insert-layout">
                <div id="quick-insert-results" class="quick-insert-results">
                    <p style="color: #8b949e;">Start typing to load snippets.</p>
                </div>
                <div class="quick-insert-preview" id="quick-insert-preview">
                    <p style="color: #8b949e;">Hover or focus a snippet to preview its replacement here.</p>
                </div>
            </div>
        </div>

        <div class="view" id="snippetsense-view">
            <h2 style="margin-bottom: 12px;">SnippetSense</h2>
            <p class="path-hint" style="margin-bottom: 16px;">Monitor repetitive phrases silently and convert them into snippets with one click. All processing stays on-device.</p>
            <div class="panel">
                <div class="panel-header">
                    <h3>Settings</h3>
                    <span id="snippetsense-status" style="font-size: 13px; color: #8b949e;">Loading...</span>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="snippetsense-enabled">
                        Enable SnippetSense
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <span>Min words</span>
                        <input type="number" id="snippetsense-min-words" min="1" max="10" value="3" style="width: 80px;">
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <span>Min chars</span>
                        <input type="number" id="snippetsense-min-chars" min="5" max="80" value="10" style="width: 80px;">
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <span>Repetition threshold</span>
                        <input type="number" id="snippetsense-threshold" min="2" max="10" value="3" style="width: 90px;">
                    </label>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-top: 16px;">
                    <div class="input-group">
                        <label>App whitelist (optional, one per line)</label>
                        <textarea id="snippetsense-whitelist" rows="4" placeholder="notepad.exe&#10;code.exe"></textarea>
                    </div>
                    <div class="input-group">
                        <label>App blacklist</label>
                        <textarea id="snippetsense-blacklist" rows="4" placeholder="keepass.exe&#10;outlook.exe"></textarea>
                    </div>
                </div>
                <p class="path-hint" id="snippetsense-filter-hint" style="margin-top: 8px;">Whitelist/blacklist limit monitoring to specific Windows executables.</p>
                <div style="margin-top: 14px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                    <button class="btn" id="snippetsense-save-settings">Save Settings</button>
                    <button class="btn secondary" id="snippetsense-refresh-suggestions">Review Suggestions</button>
                    <span id="snippetsense-meta" style="color: #8b949e; font-size: 13px;">Status unknown.</span>
                </div>
                <div id="snippetsense-alert" style="margin-top: 10px; color: #f85149; font-size: 13px; display: none;"></div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h3>Pending Suggestions</h3>
                </div>
                <div id="snippetsense-suggestions" class="help-grid">
                    <p style="color: #8b949e; font-size: 13px;">No suggestions yet.</p>
                </div>
            </div>
        </div>

        <div class="view" id="help-view">
            <h2 style="margin-bottom: 8px;">EspansoGUI Playbook</h2>
            <p class="path-hint" style="margin-bottom: 16px;">Use these guided cards to move from first launch to power-user workflows. Each card answers “what do I do next?” for a specific scenario.</p>
            <div class="help-grid">
                <div class="help-card">
                    <h4>1. First-Time Checklist</h4>
                    <ul>
                        <li>Click <strong>Dashboard → Refresh Data</strong> until the status pill turns green.</li>
                        <li>Open <strong>Paths</strong> and confirm Espanso found your config/match folders (override if needed).</li>
                        <li>Run <strong>Logs → Refresh</strong> once to ensure CLI calls succeed.</li>
                        <li>Create a manual backup (Backup view) before editing anything.</li>
                    </ul>
                </div>
                <div class="help-card">
                    <h4>2. Build Your First Snippet</h4>
                    <ul>
                        <li>Switch to <strong>Snippet IDE</strong>, press <strong>New Snippet</strong>, set a trigger like <code>:hello</code>.</li>
                        <li>Type your replacement text, drop <code>$|$</code> where the cursor should land.</li>
                        <li>Use <strong>Variables → + Add</strong> for dynamic pieces (date, clipboard, shell, etc.).</li>
                        <li>Click <strong>Save</strong>; Espanso restarts automatically and the snippet appears in the library.</li>
                    </ul>
                </div>
                <div class="help-card">
                    <h4>3. Everyday Operations</h4>
                    <ul>
                        <li>Use the <strong>Dashboard service buttons</strong> for start/stop/restart without leaving the GUI.</li>
                        <li>Track watcher/file issues via the <strong>Connection Steps</strong> log.</li>
                        <li>Edit <code>base.yml</code> in the <strong>YAML editor</strong>; backups are created automatically.</li>
                        <li>Keyboard shortcuts: Ctrl/Cmd+K (search), Ctrl/Cmd+S (save), Ctrl/Cmd+N (new), Esc (cancel).</li>
                    </ul>
                </div>
                <div class="help-card">
                    <h4>4. Library & Quick Insert</h4>
                    <ul>
                        <li>Use <strong>Quick Insert</strong> to find, preview, and copy triggers without leaving your editor.</li>
                        <li>Apply filters (file, label, has vars/forms) in the <strong>Snippet Library</strong> to tame large sets.</li>
                        <li>Multi-select cards for bulk enable/disable or export packs.</li>
                        <li>Import packs from JSON/YAML via the library header to seed new workspaces.</li>
                    </ul>
                </div>
                <div class="help-card">
                    <h4>5. Variables & Toolkits</h4>
                    <ul>
                        <li>Global variable editor lives under <strong>Variable Library → Manage Globals</strong>.</li>
                        <li>Toolkit cards preload forms for shell/date/choice fields so you can build params rapidly.</li>
                        <li>Shell helper inserts templates (<code>{{clipboard}}</code>, error handlers) and can test commands inline.</li>
                        <li>Date helper translates expressions like “+2 weeks” into Espanso offsets with previews.</li>
                    </ul>
                </div>
                <div class="help-card">
                    <h4>6. Diagnostic Lifeline</h4>
                    <ul>
                        <li><strong>Logs</strong> streams <code>espanso log</code>; use Copy to grab evidence for bug reports.</li>
                        <li><strong>Doctor</strong> runs <code>espanso doctor</code> and surfaces issues (missing deps, blocked ports).</li>
                        <li>Use <strong>Match Testing</strong> when a trigger misfires to inspect the exact match and metadata.</li>
                        <li>Manual backups + restore tools live one tab away for instant rollback.</li>
                    </ul>
                </div>
                <div class="help-card">
                    <h4>7. Advanced Authoring</h4>
                    <ul>
                        <li><strong>Forms & Regex</strong> view lets you design interactive prompts and validate regex patterns.</li>
                        <li>App-specific configs (Paths view) ship with templates for VS Code, Slack, Outlook, etc.—apply filters per app.</li>
                        <li><strong>SnippetSense</strong> runs in the background, prompting you to convert repetitive phrases into snippets with one click.</li>
                        <li>Use <strong>Paths → Storage Settings</strong> to relocate YAML/backups onto another drive or cloud folder.</li>
                    </ul>
                </div>
                <div class="help-card">
                    <h4>8. Power Tips</h4>
                    <ul>
                        <li>Switch themes via the sidebar toggle; the choice persists even when localStorage is locked down.</li>
                        <li>Every save path (snippets, globals, configs) writes timestamped backups—check the storage panel for locations.</li>
                        <li>Snippets can be disabled temporarily with the “Enabled” toggle, preserving history without removal.</li>
                        <li>On macOS/Linux, install PyQt5 + PyQtWebEngine; on Windows, keep WebView2 up to date for best performance.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="view" id="variable-library-view">
            <h2 style="margin-bottom: 16px;">Variable Library</h2>
            <div class="panel">
                <div class="panel-header">
                    <h3>Global Variables (Editable)</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn small" id="btn-add-global-var">Add Global Variable</button>
                        <button class="btn small secondary" id="btn-save-global-vars">Save All</button>
                        <button class="btn small secondary" id="btn-refresh-global">Refresh</button>
                    </div>
                </div>
                <div id="global-vars-editor" class="surface-block scroll-block block-xl">
                    <p style="color: #8b949e; font-size: 13px;">No global variables. Click "Add Global Variable" to create one.</p>
                </div>
            </div>
            <div class="panel" style="margin-top: 16px;">
                <div class="panel-header">
                    <h3>Local Variables (Read-Only)</h3>
                </div>
                <div class="global-vars-grid" id="global-vars-list">
                    <p style="color: #8b949e; font-size: 13px;">No variables detected.</p>
                </div>
            </div>
        </div>

        <div class="view" id="paths-view">
            <h2 style="margin-bottom: 16px;">Paths & Config Explorer</h2>
            <div class="path-grid">
                <div class="dash-card">
                    <h3>Config Directory</h3>
                    <div class="value" id="active-config-path" style="font-size: 12px; word-break: break-all;">-</div>
                </div>
                <div class="dash-card">
                    <h3>Match Directory</h3>
                    <div class="value" id="active-match-path" style="font-size: 12px; word-break: break-all;">-</div>
                </div>
                <div class="dash-card">
                    <h3>Packages Directory</h3>
                    <div class="value" id="active-packages-path" style="font-size: 12px; word-break: break-all;">-</div>
                </div>
                <div class="dash-card">
                    <h3>Runtime Directory</h3>
                    <div class="value" id="active-runtime-path" style="font-size: 12px; word-break: break-all;">-</div>
                </div>
            </div>
            <div class="override-form">
                <input type="text" id="path-override-input" placeholder="Custom config directory (e.g., C:\\Users\\you\\AppData\\Roaming\\espanso)">
                <button class="btn small" id="btn-apply-override">Apply Override</button>
                <button class="btn small secondary" id="btn-clear-override">Reset</button>
            </div>
            <div class="path-hint" id="path-override-status">Enter a full directory path to override auto-detection.</div>
            <div class="tree-panel" style="margin-top: 16px;">
                <div class="panel-header">
                    <h3>Storage Settings</h3>
                </div>
                <div class="path-hint">Backup root: <span id="active-backup-root">-</span></div>
                <div class="path-hint">Editor backups: <span id="active-editor-backups">-</span></div>
                <div class="path-hint">Manual backups: <span id="active-manual-backups">-</span></div>
                <div class="override-form" style="margin-top: 12px;">
                    <button class="btn small" id="btn-relocate-config">Move YAML Files</button>
                    <button class="btn small" id="btn-change-backups">Move Backup Folder</button>
                    <button class="btn small secondary" id="btn-reset-backups">Reset Backups</button>
                </div>
                <div class="path-hint" id="backup-dir-status">Backups stored in the default profile directory.</div>
            </div>
            <div class="meta-grid">
                <div class="meta-card">
                    <h4>Environment Overrides</h4>
                    <pre id="env-paths" style="white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 12px; color: #c9d1d9;">None</pre>
                </div>
                <div class="meta-card">
                    <h4>CLI Detected Paths</h4>
                    <pre id="cli-paths" style="white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 12px; color: #c9d1d9;">Pending</pre>
                </div>
            </div>
            <div style="display: flex; gap: 16px; flex: 1; min-height: 0; margin-top: 16px;">
                <div class="tree-panel">
                    <div class="panel-header">
                        <h3>Config Tree</h3>
                        <button class="btn small secondary" id="btn-refresh-tree">Refresh</button>
                    </div>
                    <div class="tree-scroll" id="config-tree-view">
                        <p class="path-hint">Loading...</p>
                    </div>
                </div>
                <div class="tree-panel">
                    <div class="panel-header">
                        <h3>Match Tree</h3>
                    </div>
                    <div class="tree-scroll" id="match-tree-view">
                        <p class="path-hint">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="tree-panel" style="margin-top: 16px;">
                <div class="panel-header">
                    <h3>Import Diagnostics</h3>
                </div>
                <div class="tree-scroll" id="import-edge-list">
                    <p class="path-hint">Fetch tree data to view imports and cycles.</p>
                </div>
            </div>
            <div class="tree-panel" style="margin-top: 16px;">
                <div class="panel-header">
                    <h3>App-Specific Configs</h3>
                    <button class="btn small secondary" id="btn-refresh-app-configs">Refresh</button>
                </div>
                <div style="padding: 12px;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                        <select id="app-template-select" style="flex: 1; min-width: 140px;">
                            <option value="">Custom (blank)</option>
                            <option value="vscode">VS Code</option>
                            <option value="chrome">Chrome/Browser</option>
                            <option value="slack">Slack</option>
                            <option value="terminal">Terminal</option>
                            <option value="outlook">Outlook</option>
                        </select>
                        <button class="btn small secondary" id="btn-load-template">Load Template</button>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <input type="text" id="app-name-input" placeholder="App name (e.g., vscode)" style="flex: 1; min-width: 120px;">
                        <input type="text" id="filter-exec-input" placeholder="Executable (optional)" style="flex: 1; min-width: 120px;">
                        <button class="btn" id="btn-create-app-config">Create Config</button>
                    </div>
                </div>
                <div id="app-config-list" class="surface-block scroll-block block-lg">
                    <p style="color: #8b949e;">No app-specific configs found.</p>
                </div>
            </div>
        </div>

        <div class="view" id="logs-view">
            <h2>Espanso Logs</h2>
            <div style="margin-bottom: 12px;">
                <button class="btn small" id="btn-refresh-logs">Refresh Logs</button>
                <button class="btn small secondary" id="btn-clear-logs">Clear Display</button>
            </div>
            <pre id="log-output" class="surface-block scroll-block block-xl code-block"></pre>
        </div>

        <div class="view" id="packages-view">
            <h2>Package Management</h2>
            <div style="margin-bottom: 12px;">
                <button class="btn small" id="btn-refresh-packages">Refresh List</button>
                <button class="btn small secondary" id="btn-update-all">Update All</button>
            </div>
            <div id="package-list" class="surface-block scroll-block block-md">
                <p style="color: #8b949e;">Loading packages...</p>
            </div>
            <div style="margin-top: 16px;">
                <h3 style="margin-bottom: 8px;">Install Package</h3>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="package-name-input" placeholder="Package name" style="flex: 1;">
                    <button class="btn" id="btn-install-package">Install</button>
                </div>
            </div>
        </div>

        <div class="view" id="match-testing-view">
            <h2>Match Testing</h2>
            <div style="margin-bottom: 16px;">
                <p style="color: #8b949e; margin-bottom: 12px;">Test if text would trigger an Espanso match. Enter text exactly as you would type it.</p>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input type="text" id="match-test-input" placeholder="Type text to test (e.g., :hello)" style="flex: 1;">
                    <button class="btn" id="btn-test-match">Test Match</button>
                </div>
                <div id="match-test-result" class="surface-block scroll-block block-sm">
                    <p style="color: #8b949e;">Enter text and click "Test Match" to see results.</p>
                </div>
            </div>
        </div>

        <div class="view" id="backup-view">
            <h2>Backup & Restore</h2>
            <div style="margin-bottom: 16px;">
                <h3 style="margin-bottom: 8px;">Create Backup</h3>
                <p style="color: #8b949e; margin-bottom: 12px; font-size: 13px;">Create a manual backup of your entire Espanso config directory.</p>
                <button class="btn" id="btn-create-backup">Create Backup Now</button>
            </div>
            <div style="margin-top: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3>Available Backups</h3>
                    <button class="btn small secondary" id="btn-refresh-backups">Refresh</button>
                </div>
                <div id="backup-list" class="surface-block scroll-block block-md">
                    <p style="color: #8b949e;">Loading backups...</p>
                </div>
            </div>
        </div>

        <div class="view" id="doctor-view">
            <h2>Espanso Diagnostics</h2>
            <div style="margin-bottom: 16px;">
                <p style="color: #8b949e; margin-bottom: 12px;">Run diagnostics to check Espanso configuration and detect issues.</p>
                <button class="btn" id="btn-run-doctor">Run Diagnostics</button>
            </div>
            <div style="margin-top: 16px;">
                <h3 style="margin-bottom: 8px;">Diagnostic Output</h3>
                <pre id="doctor-output" class="surface-block scroll-block block-lg code-block">Click "Run Diagnostics" to check your Espanso installation.</pre>
            </div>
        </div>

        <div class="view" id="forms-regex-view">
            <h2>Forms & Regex Builder</h2>

            <div class="panel" style="margin-bottom: 16px;">
                <div class="panel-header">
                    <h3>Form Builder</h3>
                </div>
                <div style="padding: 16px;">
                    <div class="input-group" style="margin-bottom: 12px;">
                        <label>Trigger</label>
                        <input type="text" id="form-trigger" placeholder=":form" class="input-base">
                    </div>

                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label style="font-weight: bold;">Form Fields</label>
                            <button class="btn small" id="btn-add-form-field" title="Create a new form field row">Add Field</button>
                        </div>
                        <div id="form-fields-container" class="field-stack">
                            <p class="muted-text">No fields. Click "Add Field" to create one.</p>
                        </div>
                    </div>

                        <div class="flex-row">
                            <button class="btn" id="btn-create-form-snippet" title="Generate a snippet using the configured form fields">Create Form Snippet</button>
                            <button class="btn secondary" id="btn-clear-form" title="Reset the form builder fields">Clear</button>
                        </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3>Regex Tester</h3>
                </div>
                <div style="padding: 16px;">
                    <div class="input-group" style="margin-bottom: 12px;">
                        <label>Regex Pattern</label>
                        <input type="text" id="regex-pattern" placeholder="^[a-z]+$" class="input-base">
                        <div id="regex-validation" style="margin-top: 4px; font-size: 12px; min-height: 18px;"></div>
                    </div>

                    <div class="input-group" style="margin-bottom: 12px;">
                        <label>Test Text</label>
                        <textarea id="regex-test-text" placeholder="Enter text to test against the pattern" class="input-base textarea-lg"></textarea>
                    </div>

                    <button class="btn" id="btn-test-regex">Test Regex</button>

                    <div id="regex-test-result" class="surface-block scroll-block block-sm" style="margin-top: 16px;">
                        <p style="color: #8b949e; font-size: 13px;">Enter a pattern and test text, then click "Test Regex".</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="variable-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="variable-modal-title">Add Variable</h3>
                <button class="modal-close" id="close-variable-modal">&times;</button>
            </div>
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="var-name" placeholder="username">
            </div>
            <div class="input-group" style="margin-top: 10px;">
                <label>Type</label>
                <select id="var-type"></select>
            </div>
            <div id="variable-params" style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;"></div>
            <div id="shell-helper-panel" class="helper-panel">
                <strong>Shell helpers</strong>
                <p class="helper-note">Insert common placeholders or test the command locally.</p>
                <div class="helper-actions">
                    <button type="button" class="btn small secondary" data-shell-template="{{input}}">Insert {{input}}</button>
                    <button type="button" class="btn small secondary" data-shell-template="{{clipboard}}">Insert {{clipboard}}</button>
                    <button type="button" class="btn small secondary" data-shell-template="{{date}}">Insert {{date}}</button>
                    <button type="button" class="btn small secondary" data-shell-template=" || echo &quot;Error&quot;">Add error handler</button>
                </div>
                <div class="helper-actions" style="align-items:center;">
                    <label style="font-size:12px; color:#8b949e; display:flex; align-items:center; gap:6px;">Timeout (s)
                        <input type="number" id="shell-test-timeout" min="1" max="30" value="5" style="width:80px; padding:6px; background:#0d1117; border:1px solid #30363d; border-radius:4px; color:#c9d1d9;">
                    </label>
                    <button class="btn small" type="button" id="btn-test-shell">Test Command</button>
                </div>
                <pre id="shell-test-result" class="helper-note" style="white-space: pre-wrap; min-height: 40px;">Output will appear here.</pre>
            </div>
            <div id="date-helper-panel" class="helper-panel">
                <strong>Date helpers</strong>
                <p class="helper-note">Generate offsets such as +7 days or -1 week and preview the formatted date.</p>
                <div class="helper-actions">
                    <button type="button" class="btn small secondary" data-date-offset="+1 day">+1 day</button>
                    <button type="button" class="btn small secondary" data-date-offset="+7 days">+7 days</button>
                    <button type="button" class="btn small secondary" data-date-offset="-1 week">-1 week</button>
                    <button type="button" class="btn small secondary" data-date-offset="+1 hour">+1 hour</button>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <input type="text" id="date-offset-expression" placeholder="+7 days" style="flex:1; padding:8px; background:#0d1117; border:1px solid #30363d; border-radius:6px; color:#c9d1d9;">
                    <button class="btn small" type="button" id="btn-apply-date-offset">Apply Offset</button>
                </div>
                <div id="date-helper-output" class="helper-note">Preview will appear here.</div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap;">
                <button class="btn" id="btn-save-variable">Save Variable</button>
                <button class="btn secondary" id="btn-cancel-variable">Cancel</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="snippetsense-toast-container" id="snippetsense-toast-container"></div>

    <script>
        const snippetState = {
            list: [],
            currentTrigger: null,
            vars: [],
            variableTypes: [],
            globalVars: [],
            editingVarIndex: null,
            modalMode: 'add'
        };

        const snippetSearchState = {
            query: '',
            filters: {
                file: '',
                enabled: '',
                hasVars: false,
                hasForm: false,
                label: ''
            },
            results: [],
            total: 0
        };

        const quickInsertState = {
            query: '',
            results: []
        };

        const snippetSenseState = {
            settings: null,
            pending: [],
            available: true,
            running: false,
            status: {},
            seenIds: new Set(),
            toastIds: new Set()
        };
        let snippetSensePollTimer = null;
        let lastDiagnosticsRun = 0;
        let diagnosticsInProgress = false;

        const PARAM_CONFIG = {
            format: { label: 'Format', placeholder: '%Y-%m-%d %H:%M' },
            offset: { label: 'Offset (seconds)', type: 'number' },
            choices: { label: 'Choices', type: 'textarea', helper: 'One option per line', dataType: 'list' },
            values: { label: 'Values', type: 'textarea', helper: 'One value per line', dataType: 'list' },
            args: { label: 'Args', type: 'textarea', helper: 'One arg per line', dataType: 'list' },
            fields: { label: 'Fields', type: 'textarea', helper: 'One field per line', dataType: 'list' },
            cmd: { label: 'Shell Command', type: 'textarea', placeholder: 'uuidgen' },
            shell: { label: 'Use shell (true/false)', placeholder: 'false' },
            fallback: { label: 'Fallback value', placeholder: 'default text' },
            prompt: { label: 'Prompt', placeholder: 'Enter value...' },
            trigger: { label: 'Match trigger', placeholder: ':other-snippet' }
        };

        const snippetListEl = document.getElementById('snippet-list');
        const snippetSearchInput = document.getElementById('snippet-search');
        const snippetFileFilter = document.getElementById('snippet-file-filter');
        const snippetEnabledFilter = document.getElementById('snippet-enabled-filter');
        const snippetVarsFilter = document.getElementById('snippet-filter-vars');
        const snippetFormsFilter = document.getElementById('snippet-filter-forms');
        const snippetLabelFilter = document.getElementById('snippet-label-filter');
        const snippetSearchSummary = document.getElementById('snippet-search-summary');
        const snippetLabelInput = document.getElementById('snippet-label');
        const snippetEnabledInput = document.getElementById('snippet-enabled');
        const snippetBackendSelect = document.getElementById('snippet-backend');
        const snippetDelayInput = document.getElementById('snippet-delay');
        const snippetLeftWordInput = document.getElementById('snippet-left-word');
        const snippetRightWordInput = document.getElementById('snippet-right-word');
        const snippetUppercaseStyleSelect = document.getElementById('snippet-uppercase-style');
        const snippetImagePathInput = document.getElementById('snippet-image-path');
        const snippetImagePreviewEl = document.getElementById('snippet-image-preview');
        const variableListEl = document.getElementById('variable-list');
        const globalVarsEl = document.getElementById('global-vars-list');
        const variableTypeGrid = document.getElementById('variable-type-grid');
        const variableModal = document.getElementById('variable-modal');
        const quickInsertInput = document.getElementById('quick-insert-input');
        const quickInsertResultsEl = document.getElementById('quick-insert-results');
        const quickInsertPreviewEl = document.getElementById('quick-insert-preview');
        const quickInsertClearBtn = document.getElementById('btn-clear-quick-insert');
        const shellHelperPanel = document.getElementById('shell-helper-panel');
        const dateHelperPanel = document.getElementById('date-helper-panel');
        const shellTestResultEl = document.getElementById('shell-test-result');
        const shellTimeoutInput = document.getElementById('shell-test-timeout');
        const dateOffsetExpressionInput = document.getElementById('date-offset-expression');
        const dateHelperOutputEl = document.getElementById('date-helper-output');
        let imagePreviewDebounce = null;

        const settingsToggle = document.getElementById('settings-toggle');
        const settingsSubnav = document.getElementById('settings-subnav');
        const settingsViews = new Set(['paths', 'logs', 'packages', 'backup', 'doctor', 'help']);

        document.querySelectorAll('.nav-btn').forEach(btn => {
            if (btn === settingsToggle) return;
            const targetView = btn.dataset.view;
            if (targetView) {
                btn.addEventListener('click', () => switchView(targetView));
                if (!btn.title) {
                    btn.title = `Switch to ${btn.textContent.trim()} view`;
                }
            }
        });

        settingsToggle?.addEventListener('click', () => {
            const expanded = settingsSubnav?.classList.toggle('open');
            const open = expanded ? '▾' : '▸';
            if (settingsToggle) settingsToggle.innerHTML = `Settings & Tools ${open}`;
            settingsToggle?.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        });

        function switchView(view) {
            if (!view) return;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const navTarget = document.querySelector(`[data-view="${view}"]`);
            if (navTarget) navTarget.classList.add('active');
            if (settingsViews.has(view) && settingsSubnav && settingsToggle) {
                settingsSubnav.classList.add('open');
                settingsToggle.innerHTML = 'Settings & Tools ▾';
                settingsToggle.setAttribute('aria-expanded', 'true');
            }
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${view}-view`).classList.add('active');

            if (view === 'editor') {
                loadEditor();
            } else if (view === 'snippet') {
                loadSnippetIDE();
            } else if (view === 'snippet-library') {
                loadSnippetList();
            } else if (view === 'variable-library') {
                loadGlobalVars();
                loadVariableTypes();
                loadGlobalVariables();
            } else if (view === 'paths') {
                loadPathsPanel();
                loadAppConfigs();
            } else if (view === 'logs') {
                loadLogs();
            } else if (view === 'packages') {
                loadPackages();
            } else if (view === 'backup') {
                loadBackups();
            } else if (view === 'forms-regex') {
                renderFormFields();
            } else if (view === 'quick-insert') {
                if (!snippetState.list.length) {
                    loadSnippetList(false).then(() => updateQuickInsertResults());
                } else {
                    updateQuickInsertResults();
                }
            } else if (view === 'snippetsense') {
                loadSnippetSenseState();
            } else if (view === 'help') {
                // Static content, no extra load required
            } else if (view === 'doctor') {
                loadDoctorDiagnostics();
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2800);
        }

        function isWebview() {
            return window.pywebview && window.pywebview.api;
        }

        function escapeHtml(str = '') {
            return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c] || c));
        }

        function escapeRegExp(str = '') {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightMatch(text, query) {
            const safeText = escapeHtml(text || '');
            const needle = (query || '').trim();
            if (!needle) return safeText;
            const pattern = escapeRegExp(needle);
            if (!pattern) return safeText;
            return safeText.replace(new RegExp(pattern, 'gi'), match => `<mark>${match}</mark>`);
        }

        const pause = (ms = 100) => new Promise(resolve => setTimeout(resolve, ms));

        async function waitForBridge(timeout = 8000) {
            const start = performance.now();
            while (performance.now() - start < timeout) {
                if (isWebview()) {
                    return true;
                }
                await pause(120);
            }
            throw new Error('PyWebView bridge unavailable');
        }

        async function waitForBackendReady(timeout = 8000) {
            await waitForBridge(timeout);
            const start = performance.now();
            while (performance.now() - start < timeout) {
                try {
                    const heartbeat = await window.pywebview.api.ping();
                    if (heartbeat && (heartbeat.ready || typeof heartbeat.snippetCount === 'number')) {
                        return heartbeat;
                    }
                } catch (err) {
                    // Backend not ready yet; continue polling silently
                }
                await pause(200);
            }
            throw new Error('Backend did not report ready state');
        }

        async function loadDashboard() {
            if (!isWebview()) {
                document.getElementById('status-text').textContent = 'Offline (not in pywebview)';
                return;
            }
            try {
                const dashboard = await window.pywebview.api.get_dashboard();

                // Update connection status
                const connected = dashboard.statusMessage === 'Connected';
                document.getElementById('connection-indicator').className = 'status-indicator ' + (connected ? 'connected' : 'disconnected');
                document.getElementById('status-text').textContent = dashboard.statusMessage || 'Loading...';

                // Update dashboard metrics with safe defaults
                document.getElementById('snippet-count').textContent = `${dashboard.snippetCount || 0} snippets`;
                document.getElementById('service-status').textContent = dashboard.cliStatus || 'Unknown';
                document.getElementById('total-snippets').textContent = dashboard.snippetCount || 0;
                document.getElementById('config-path').textContent = dashboard.configPath || 'Not configured';

                // Update connection steps if available
                if (dashboard.connectionSteps && Array.isArray(dashboard.connectionSteps)) {
                    const html = dashboard.connectionSteps.map(step => {
                        const icon = step.status === 'success' ? '✓' : '⚠';
                        return `<div style="margin: 4px 0;">${icon} ${escapeHtml(step.label)}: ${escapeHtml(step.detail || '')}</div>`;
                    }).join('');
                    document.getElementById('connection-steps').innerHTML = html || '<div style="color:#8b949e;">No connection diagnostics available.</div>';
                } else {
                    document.getElementById('connection-steps').innerHTML = '<div style="color:#8b949e;">Loading diagnostics...</div>';
                }

                console.log('Dashboard loaded successfully:', dashboard);
            } catch (err) {
                console.error('Dashboard load error:', err);
                document.getElementById('status-text').textContent = 'Error loading dashboard';
                document.getElementById('connection-indicator').className = 'status-indicator disconnected';
                showToast('Failed to load dashboard: ' + err.message, true);
                throw err; // Re-throw so bootstrap can retry
            }
        }

        document.getElementById('btn-start').addEventListener('click', async () => {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.start_service();
                showToast(result.detail || 'Start issued');
                setTimeout(loadDashboard, 600);
            } catch (err) {
                showToast('Failed: ' + err.message, true);
            }
        });
        document.getElementById('btn-stop').addEventListener('click', async () => {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.stop_service();
                showToast(result.detail || 'Stop issued');
                setTimeout(loadDashboard, 600);
            } catch (err) {
                showToast('Failed: ' + err.message, true);
            }
        });
        document.getElementById('btn-restart').addEventListener('click', async () => {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.restart_service();
                showToast(result.detail || 'Restart issued');
                setTimeout(loadDashboard, 600);
            } catch (err) {
                showToast('Failed: ' + err.message, true);
            }
        });
        async function refreshAncillaryData(options = {}) {
            if (!isWebview()) return;
            const tasks = [
                loadSnippetList(false),
                loadPathsPanel(),
                loadLogs({silent: options.silent})
            ];
            tasks.push(runDoctorDiagnostics(true));
            await Promise.allSettled(tasks);
        }

        async function refreshAll() {
            try {
                await waitForBackendReady();
            } catch (err) {
                console.warn('Backend readiness check failed during refresh', err);
            }
            await loadDashboard();
            await refreshAncillaryData();
        }

        document.getElementById('btn-refresh').addEventListener('click', refreshAll);

        async function loadEditor() {
            if (!isWebview()) {
                document.getElementById('yaml-editor').value = '# Not connected to pywebview';
                return;
            }
            try {
                document.getElementById('editor-status').textContent = 'Loading...';
                const result = await window.pywebview.api.get_base_yaml();
                if (result.status === 'success') {
                    document.getElementById('yaml-editor').value = result.content;
                    document.getElementById('editor-status').textContent = `Loaded: ${result.path}`;
                } else {
                    document.getElementById('yaml-editor').value = '# Error: ' + result.detail;
                    document.getElementById('editor-status').textContent = 'Load failed';
                    showToast(result.detail, true);
                }
            } catch (err) {
                showToast('Failed to load YAML: ' + err.message, true);
            }
        }

        document.getElementById('btn-save-yaml').addEventListener('click', async () => {
            if (!isWebview()) return;
            try {
                const content = document.getElementById('yaml-editor').value;
                document.getElementById('editor-status').textContent = 'Saving...';
                const result = await window.pywebview.api.save_base_yaml(content);
                if (result.status === 'success') {
                    showToast(result.detail);
                    document.getElementById('editor-status').textContent = 'Saved successfully';
                    setTimeout(loadDashboard, 600);
                } else {
                    showToast(result.detail, true);
                    document.getElementById('editor-status').textContent = 'Save failed';
                }
            } catch (err) {
                showToast('Failed to save: ' + err.message, true);
            }
        });
        document.getElementById('btn-reload-yaml').addEventListener('click', loadEditor);

        function renderPathMappings(targetId, mapping) {
            const target = document.getElementById(targetId);
            const entries = Object.keys(mapping || {}).length
                ? Object.entries(mapping).map(([key, value]) => `${escapeHtml(key)}: ${escapeHtml(value)}`).join('\n')
                : 'None';
            target.textContent = entries;
        }

        function updateOverrideStatus(message, isError = false) {
            const statusEl = document.getElementById('path-override-status');
            statusEl.textContent = message;
            statusEl.style.color = isError ? '#f85149' : '#8b949e';
        }

        function buildTreeMarkup(node) {
            if (!node) {
                return '<p class="path-hint">No data.</p>';
            }
            return `<ul class="tree-list">${renderTreeNode(node)}</ul>`;
        }

        function renderTreeNode(node) {
            if (!node) return '';
            const badge = node.type === 'directory' ? 'dir' : node.type;
            const children = Array.isArray(node.children) && node.children.length
                ? `<ul class="tree-list">${node.children.map(renderTreeNode).join('')}</ul>`
                : '';
            return `
                <li>
                    <div class="tree-node-label">
                        <span>${escapeHtml(node.name || '')}</span>
                        <span class="badge">${escapeHtml(badge || '')}</span>
                    </div>
                    ${children}
                </li>
            `;
        }

        function renderImportDiagnostics(importData = {}) {
            const container = document.getElementById('import-edge-list');
            const edges = (importData.edges || []).map(edge => {
                const status = edge.exists ? '✓' : '⚠';
                return `<div class="path-hint">${status} ${escapeHtml(edge.source || '')} → ${escapeHtml(edge.target || '')}</div>`;
            }).join('') || '<p class="path-hint">No imports found.</p>';

            const warnings = [];
            (importData.warnings || []).forEach(w => warnings.push(w));
            (importData.missing || []).forEach(miss => warnings.push(`Missing: ${miss}`));
            (importData.cycles || []).forEach(cycle => warnings.push(`Cycle: ${cycle.join(' → ')}`));

            const warningBlock = warnings.length
                ? `<div style="margin-top:10px; color:#f85149; font-size:12px;">${warnings.map(w => `<div>${escapeHtml(w)}</div>`).join('')}</div>`
                : '';

            container.innerHTML = edges + warningBlock;
        }

        async function loadConfigExplorer() {
            if (!isWebview()) return;
            try {
                const summary = await window.pywebview.api.get_config_tree();
                document.getElementById('config-tree-view').innerHTML = buildTreeMarkup(summary.configTree);
                document.getElementById('match-tree-view').innerHTML = buildTreeMarkup(summary.matchTree);
                renderImportDiagnostics(summary.imports);
            } catch (err) {
                showToast('Failed to load config tree: ' + err.message, true);
            }
        }

        async function loadPathsPanel() {
            if (!isWebview()) {
                updateOverrideStatus('Not connected to backend.', true);
                return;
            }
            try {
                const settings = await window.pywebview.api.get_path_settings();
                document.getElementById('active-config-path').textContent = settings.config;
                document.getElementById('active-match-path').textContent = settings.match;
                document.getElementById('active-packages-path').textContent = settings.packages;
                document.getElementById('active-runtime-path').textContent = settings.runtime;
                document.getElementById('path-override-input').value = settings.override || '';
                renderPathMappings('env-paths', settings.envOverrides || {});
                renderPathMappings('cli-paths', settings.cliDetected || {});
                updateOverrideStatus(settings.override ? `Override active: ${settings.override}` : 'Auto-detected paths in use');
                document.getElementById('active-backup-root').textContent = settings.storageRoot || '-';
                document.getElementById('active-editor-backups').textContent = settings.editorBackups || '-';
                document.getElementById('active-manual-backups').textContent = settings.manualBackups || '-';
                const backupStatus = document.getElementById('backup-dir-status');
                if (backupStatus) {
                    backupStatus.textContent = settings.storageOverride
                        ? `Custom backup root active: ${settings.storageRoot}`
                        : 'Backups stored in the default profile directory.';
                }
                await loadConfigExplorer();
            } catch (err) {
                showToast('Failed to load path settings: ' + err.message, true);
                updateOverrideStatus('Unable to load paths', true);
            }
        }

        document.getElementById('btn-apply-override').addEventListener('click', async () => {
            if (!isWebview()) return;
            const value = (document.getElementById('path-override-input').value || '').trim();
            if (!value) {
                updateOverrideStatus('Enter a directory path first.', true);
                return;
            }
            try {
                const result = await window.pywebview.api.set_config_override(value);
                if (result.status === 'success') {
                    updateOverrideStatus(result.detail || 'Override applied');
                    await loadPathsPanel();
                    setTimeout(loadDashboard, 600);
                } else {
                    updateOverrideStatus(result.detail || 'Override failed', true);
                }
            } catch (err) {
                updateOverrideStatus('Failed: ' + err.message, true);
            }
        });

        document.getElementById('btn-clear-override').addEventListener('click', async () => {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.clear_config_override();
                updateOverrideStatus(result.detail || 'Override cleared');
                document.getElementById('path-override-input').value = '';
                await loadPathsPanel();
                setTimeout(loadDashboard, 600);
            } catch (err) {
                updateOverrideStatus('Failed to clear override: ' + err.message, true);
            }
        });

        async function pickDirectoryPath(promptText) {
            if (!isWebview()) return null;
            try {
                const response = await window.pywebview.api.pick_path_dialog(promptText || 'Select folder', true);
                if (response.status === 'success' && response.path) {
                    return response.path;
                }
                return null;
            } catch (err) {
                showToast('Folder picker failed: ' + err.message, true);
                return null;
            }
        }

        document.getElementById('btn-relocate-config')?.addEventListener('click', async () => {
            const path = await pickDirectoryPath('Select new Espanso config directory');
            if (!path) return;
            const migrate = confirm('Copy existing Espanso YAML/config files into the new directory?');
            try {
                const result = await window.pywebview.api.relocate_config_directory(path, migrate);
                showToast(result.detail || 'Config directory updated', result.status !== 'success');
                if (result.status === 'success') {
                    await loadPathsPanel();
                    setTimeout(loadDashboard, 800);
                }
            } catch (err) {
                showToast('Failed to move config directory: ' + err.message, true);
            }
        });

        document.getElementById('btn-change-backups')?.addEventListener('click', async () => {
            const path = await pickDirectoryPath('Select new backup directory');
            if (!path) return;
            const migrate = confirm('Move existing backups to the new directory?');
            try {
                const result = await window.pywebview.api.set_storage_root(path, migrate);
                showToast(result.detail || 'Backup directory updated', result.status !== 'success');
                if (result.status === 'success') {
                    await loadPathsPanel();
                }
            } catch (err) {
                showToast('Failed to update backup directory: ' + err.message, true);
            }
        });

        document.getElementById('btn-reset-backups')?.addEventListener('click', async () => {
            if (!confirm('Reset backup storage to the default profile directory?')) return;
            try {
                const result = await window.pywebview.api.clear_storage_root();
                showToast(result.detail || 'Backups reset', result.status !== 'success');
                if (result.status === 'success') {
                    await loadPathsPanel();
                }
            } catch (err) {
                showToast('Failed to reset backups: ' + err.message, true);
            }
        });

        document.getElementById('btn-refresh-tree').addEventListener('click', loadConfigExplorer);

        document.getElementById('btn-create-app-config')?.addEventListener('click', async () => {
            const appName = document.getElementById('app-name-input').value.trim();
            const filterExec = document.getElementById('filter-exec-input').value.trim();
            if (!appName) {
                showToast('App name is required', true);
                return;
            }
            try {
                const result = await window.pywebview.api.create_app_config(appName, filterExec);
                showToast(result.detail, result.status !== 'success');
                if (result.status === 'success') {
                    document.getElementById('app-name-input').value = '';
                    document.getElementById('filter-exec-input').value = '';
                    await loadConfigExplorer();
                }
            } catch (err) {
                showToast('Failed to create config: ' + err.message, true);
            }
        });

        function updateDashboardLogPreview(text) {
            const previewEl = document.getElementById('dashboard-log-preview');
            if (!previewEl) return;
            if (!text) {
                previewEl.textContent = 'No logs yet.';
                return;
            }
            const lines = text.split('\n');
            const snippet = lines.slice(-12).join('\n');
            previewEl.textContent = snippet || 'No logs yet.';
        }

        async function loadLogs(options = {}) {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.get_logs(200);
                const output = document.getElementById('log-output');
                if (result.status === 'success') {
                    const text = result.logs.join('\n');
                    if (output) {
                        output.textContent = text || 'No logs yet.';
                        output.scrollTop = output.scrollHeight;
                    }
                    updateDashboardLogPreview(text);
                } else if (output) {
                    output.textContent = 'Error loading logs: ' + result.detail;
                    updateDashboardLogPreview(output.textContent);
                }
            } catch (err) {
                const fallback = 'Failed to load logs: ' + err.message;
                const output = document.getElementById('log-output');
                if (output) output.textContent = fallback;
                updateDashboardLogPreview(fallback);
            }
        }

        async function loadPackages() {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.list_packages();
                const listEl = document.getElementById('package-list');
                if (result.status === 'success') {
                    if (result.packages.length === 0) {
                        listEl.innerHTML = '<p style="color: #8b949e;">No packages installed</p>';
                    } else {
                        listEl.innerHTML = result.packages.map(pkg => `
                            <div style="padding: 8px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
                                <span>${pkg}</span>
                                <button class="btn small secondary" onclick="uninstallPackage('${pkg.split(' ')[0]}')">Uninstall</button>
                            </div>
                        `).join('');
                    }
                } else {
                    listEl.innerHTML = `<p style="color: #f85149;">Error: ${result.detail}</p>`;
                }
            } catch (err) {
                document.getElementById('package-list').innerHTML = '<p style="color: #f85149;">Failed: ' + err.message + '</p>';
            }
        }

        async function uninstallPackage(packageName) {
            if (!confirm(`Uninstall package "${packageName}"?`)) return;
            try {
                showToast(`Uninstalling ${packageName}...`);
                const result = await window.pywebview.api.uninstall_package(packageName);
                showToast(result.detail, result.status !== 'success');
                if (result.status === 'success') await loadPackages();
            } catch (err) {
                showToast('Uninstall failed: ' + err.message, true);
            }
        }

        window.uninstallPackage = uninstallPackage;

        async function packageOp(operation, packageName = '') {
            try {
                showToast(`Running ${operation}...`);
                const result = await window.pywebview.api.package_operation(operation, packageName);
                showToast(result.detail, result.status !== 'success');
                if (result.status === 'success') await loadPackages();
            } catch (err) {
                showToast('Operation failed: ' + err.message, true);
            }
        }

        document.getElementById('btn-refresh-logs')?.addEventListener('click', loadLogs);
        document.getElementById('btn-clear-logs')?.addEventListener('click', () => {
            document.getElementById('log-output').textContent = '';
        });
        document.getElementById('btn-refresh-packages')?.addEventListener('click', loadPackages);
        document.getElementById('btn-update-all')?.addEventListener('click', () => packageOp('update'));
        document.getElementById('btn-install-package')?.addEventListener('click', () => {
            const name = document.getElementById('package-name-input').value.trim();
            if (name) {
                packageOp('install', name);
                document.getElementById('package-name-input').value = '';
            }
        });

        const selectedSnippets = new Set();

        function toggleSnippetSelection(trigger, isChecked) {
            if (isChecked) {
                selectedSnippets.add(trigger);
            } else {
                selectedSnippets.delete(trigger);
            }
            const bulkEnableBtn = document.getElementById('btn-bulk-enable');
            const bulkDisableBtn = document.getElementById('btn-bulk-disable');
            const exportBtn = document.getElementById('btn-export-selected');
            const hasSelection = selectedSnippets.size > 0;
            if (bulkEnableBtn) bulkEnableBtn.disabled = !hasSelection;
            if (bulkDisableBtn) bulkDisableBtn.disabled = !hasSelection;
            if (exportBtn) exportBtn.disabled = !hasSelection;
        }

        document.getElementById('btn-bulk-enable')?.addEventListener('click', async () => {
            if (selectedSnippets.size === 0) return;
            const count = selectedSnippets.size;
            if (!confirm(`Enable ${count} selected snippet(s)?`)) return;
            try {
                for (const trigger of selectedSnippets) {
                    const snippet = snippetState.list.find(s => s.trigger === trigger);
                    if (snippet) {
                        snippet.enabled = true;
                        await window.pywebview.api.update_snippet(trigger, {...snippet, enabled: true});
                    }
                }
                selectedSnippets.clear();
                await loadSnippetList();
                showToast(`Enabled ${count} snippet(s)`);
            } catch (err) {
                showToast('Bulk enable failed: ' + err.message, true);
            }
        });

        document.getElementById('btn-bulk-disable')?.addEventListener('click', async () => {
            if (selectedSnippets.size === 0) return;
            const count = selectedSnippets.size;
            if (!confirm(`Disable ${count} selected snippet(s)?`)) return;
            try {
                for (const trigger of selectedSnippets) {
                    const snippet = snippetState.list.find(s => s.trigger === trigger);
                    if (snippet) {
                        snippet.enabled = false;
                        await window.pywebview.api.update_snippet(trigger, {...snippet, enabled: false});
                    }
                }
                selectedSnippets.clear();
                await loadSnippetList();
                showToast(`Disabled ${count} snippet(s)`);
            } catch (err) {
                showToast('Bulk disable failed: ' + err.message, true);
            }
        });

        document.getElementById('btn-export-selected')?.addEventListener('click', async () => {
            if (selectedSnippets.size === 0) {
                showToast('No snippets selected', true);
                return;
            }
            try {
                const result = await window.pywebview.api.pick_path_dialog('save', 'Select export location', 'snippet_pack.json');
                if (result.status === 'success' && result.path) {
                    const triggers = Array.from(selectedSnippets);
                    const exportResult = await window.pywebview.api.export_snippet_pack(triggers, result.path);
                    showToast(exportResult.detail, exportResult.status !== 'success');
                    if (exportResult.status === 'success') {
                        selectedSnippets.clear();
                        await loadSnippetList();
                    }
                }
            } catch (err) {
                showToast('Export failed: ' + err.message, true);
            }
        });

        document.getElementById('btn-import-pack')?.addEventListener('click', async () => {
            try {
                const result = await window.pywebview.api.pick_path_dialog('file', 'Select snippet pack to import', '*.json;*.yml;*.yaml');
                if (result.status === 'success' && result.path) {
                    const importResult = await window.pywebview.api.import_snippet_pack(result.path);
                    showToast(importResult.detail, importResult.status !== 'success');
                    if (importResult.status === 'success') {
                        await loadSnippetList();
                    }
                }
            } catch (err) {
                showToast('Import failed: ' + err.message, true);
            }
        });

        const globalVarsState = [];

        async function loadGlobalVariables() {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.get_global_variables();
                const editorEl = document.getElementById('global-vars-editor');
                if (result.status === 'success') {
                    globalVarsState.length = 0;
                    globalVarsState.push(...result.variables);
                    renderGlobalVariables();
                } else {
                    editorEl.innerHTML = `<p style="color: #f85149;">Error: ${result.detail}</p>`;
                }
            } catch (err) {
                document.getElementById('global-vars-editor').innerHTML = '<p style="color: #f85149;">Failed: ' + err.message + '</p>';
            }
        }

        function renderGlobalVariables() {
            const editorEl = document.getElementById('global-vars-editor');
            if (globalVarsState.length === 0) {
                editorEl.innerHTML = '<p style="color: #8b949e; font-size: 13px;">No global variables. Click "Add Global Variable" to create one.</p>';
                return;
            }
            editorEl.innerHTML = globalVarsState.map((varItem, index) => {
                const varType = varItem.type || varItem.var_type || 'echo';
                return `
                <div class="surface-block card-row">
                    <input type="text" placeholder="Variable name" value="${varItem.name || ''}"
                           onchange="updateGlobalVar(${index}, 'name', this.value)"
                           class="input-base flex-1">
                    <select onchange="updateGlobalVar(${index}, 'type', this.value)"
                            class="input-base" style="flex: 0 0 140px;">
                        <option value="shell" ${varType === 'shell' ? 'selected' : ''}>Shell</option>
                        <option value="clipboard" ${varType === 'clipboard' ? 'selected' : ''}>Clipboard</option>
                        <option value="choice" ${varType === 'choice' ? 'selected' : ''}>Choice</option>
                        <option value="echo" ${varType === 'echo' ? 'selected' : ''}>Echo</option>
                        <option value="date" ${varType === 'date' ? 'selected' : ''}>Date</option>
                    </select>
                    ${varType === 'shell' ? `
                        <input type="text" placeholder="Shell command" value="${varItem.params?.cmd || ''}"
                               onchange="updateGlobalVarParam(${index}, 'cmd', this.value)"
                               class="input-base flex-2">
                    ` : ''}
                    ${varType === 'choice' ? `
                        <input type="text" placeholder="Choices (comma-separated)" value="${(varItem.params?.values || []).join(', ')}"
                               onchange="updateGlobalVarParam(${index}, 'values', this.value.split(',').map(v => v.trim()))"
                               class="input-base flex-2">
                    ` : ''}
                    ${varType === 'echo' ? `
                        <input type="text" placeholder="Echo value" value="${varItem.params?.echo || ''}"
                               onchange="updateGlobalVarParam(${index}, 'echo', this.value)"
                               class="input-base flex-2">
                    ` : ''}
                    ${varType === 'date' ? `
                        <input type="text" placeholder="Date format (e.g. %Y-%m-%d)" value="${varItem.params?.format || ''}"
                               onchange="updateGlobalVarParam(${index}, 'format', this.value)"
                               class="input-base flex-2">
                    ` : ''}
                    <button onclick="removeGlobalVar(${index})" class="btn small secondary" style="padding: 6px 12px;">Remove</button>
                </div>
                `;
            }).join('');
        }

        window.updateGlobalVar = (index, field, value) => {
            if (globalVarsState[index]) {
                globalVarsState[index][field] = value;
            }
        };

        window.updateGlobalVarParam = (index, param, value) => {
            if (globalVarsState[index]) {
                if (!globalVarsState[index].params) globalVarsState[index].params = {};
                globalVarsState[index].params[param] = value;
            }
        };

        window.removeGlobalVar = (index) => {
            globalVarsState.splice(index, 1);
            renderGlobalVariables();
        };

        document.getElementById('btn-add-global-var')?.addEventListener('click', () => {
            globalVarsState.push({ name: '', type: 'echo', params: { echo: '' } });
            renderGlobalVariables();
        });

        document.getElementById('btn-save-global-vars')?.addEventListener('click', async () => {
            try {
                const result = await window.pywebview.api.update_global_variables(globalVarsState);
                showToast(result.detail, result.status !== 'success');
            } catch (err) {
                showToast('Save failed: ' + err.message, true);
            }
        });

        document.getElementById('btn-refresh-global')?.addEventListener('click', loadGlobalVariables);

        const formFieldsState = [];

        function renderFormFields() {
            const container = document.getElementById('form-fields-container');
            if (formFieldsState.length === 0) {
                container.innerHTML = '<p style="color: #8b949e; font-size: 13px;">No fields. Click "Add Field" to create one.</p>';
                return;
            }
            container.innerHTML = formFieldsState.map((field, index) => {
                const requiresValues = ['choice', 'list', 'radio', 'select'].includes(field.type);
                const showTextDefault = field.type === 'text';
                const showCheckboxDefault = field.type === 'checkbox';
                const valuesHtml = requiresValues ? `
                    <textarea placeholder="One option per line" onchange="updateFormFieldValues(${index}, this.value)"
                              style="flex: 2; padding: 8px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px; min-height: 70px;">${(field.values || []).join('\n')}</textarea>
                ` : '';
                const defaultHtml = showTextDefault ? `
                    <input type="text" placeholder="Default value (optional)" value="${field.default || ''}"
                           onchange="updateFormField(${index}, 'default', this.value)"
                           style="flex: 2; padding: 8px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px;">
                ` : '';
                const checkboxToggle = showCheckboxDefault ? `
                    <label style="display:flex; align-items:center; gap:6px; color:#8b949e; font-size:12px;">
                        <input type="checkbox" ${field.default ? 'checked' : ''} onchange="updateFormField(${index}, 'default', this.checked)">
                        Default checked
                    </label>
                ` : '';
                return `
                    <div style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: #161b22; border-radius: 6px;">
                        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                            <input type="text" placeholder="Field name" value="${field.name || ''}"
                                   onchange="updateFormField(${index}, 'name', this.value)"
                                   style="flex: 1; min-width: 140px; padding: 8px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px;">
                            <select onchange="updateFormField(${index}, 'type', this.value)"
                                    style="padding: 8px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px;">
                                <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option>
                                <option value="choice" ${field.type === 'choice' ? 'selected' : ''}>Choice (buttons)</option>
                                <option value="list" ${field.type === 'list' ? 'selected' : ''}>List (multi-select)</option>
                                <option value="radio" ${field.type === 'radio' ? 'selected' : ''}>Radio group</option>
                                <option value="select" ${field.type === 'select' ? 'selected' : ''}>Dropdown</option>
                                <option value="checkbox" ${field.type === 'checkbox' ? 'selected' : ''}>Checkbox</option>
                            </select>
                            <button onclick="removeFormField(${index})" class="btn small secondary" style="padding: 6px 12px;" title="Remove this field">Remove</button>
                        </div>
                        ${valuesHtml}
                        ${defaultHtml}
                        ${checkboxToggle}
                    </div>
                `;
            }).join('');
        }

        window.updateFormField = (index, field, value) => {
            if (formFieldsState[index]) {
                formFieldsState[index][field] = value;
                if (field === 'type') {
                    if (['choice', 'list', 'radio', 'select'].includes(value) && !Array.isArray(formFieldsState[index].values)) {
                        formFieldsState[index].values = [];
                    }
                    if (value === 'checkbox') {
                        formFieldsState[index].default = Boolean(formFieldsState[index].default);
                    } else if (value !== 'text') {
                        delete formFieldsState[index].default;
                    }
                }
            }
        };

        window.updateFormFieldValues = (index, value) => {
            if (formFieldsState[index]) {
                formFieldsState[index].values = value
                    .split(/[\n,]/)
                    .map(v => v.trim())
                    .filter(Boolean);
            }
        };

        window.removeFormField = (index) => {
            formFieldsState.splice(index, 1);
            renderFormFields();
        };

        document.getElementById('btn-add-form-field')?.addEventListener('click', () => {
            formFieldsState.push({ name: '', type: 'text', default: '', values: [] });
            renderFormFields();
        });

        document.getElementById('btn-create-form-snippet')?.addEventListener('click', async () => {
            const trigger = document.getElementById('form-trigger').value.trim();
            if (!trigger) {
                showToast('Trigger is required', true);
                return;
            }
            if (formFieldsState.length === 0) {
                showToast('Add at least one field', true);
                return;
            }
            try {
                const result = await window.pywebview.api.create_form_snippet(trigger, formFieldsState);
                showToast(result.detail, result.status !== 'success');
                if (result.status === 'success') {
                    document.getElementById('form-trigger').value = '';
                    formFieldsState.length = 0;
                    renderFormFields();
                    await loadSnippetList();
                }
            } catch (err) {
                showToast('Create failed: ' + err.message, true);
            }
        });

        document.getElementById('btn-clear-form')?.addEventListener('click', () => {
            document.getElementById('form-trigger').value = '';
            formFieldsState.length = 0;
            renderFormFields();
        });

        document.getElementById('regex-pattern')?.addEventListener('input', async (e) => {
            const pattern = e.target.value;
            const validationEl = document.getElementById('regex-validation');
            if (!pattern) {
                validationEl.innerHTML = '';
                return;
            }
            try {
                const result = await window.pywebview.api.validate_regex(pattern);
                if (result.valid) {
                    validationEl.innerHTML = '<span style="color: #3fb950;">✓ Valid regex pattern</span>';
                } else {
                    validationEl.innerHTML = `<span style="color: #f85149;">✗ ${result.detail}</span>`;
                }
            } catch (err) {
                validationEl.innerHTML = `<span style="color: #f85149;">Error: ${err.message}</span>`;
            }
        });

        document.getElementById('btn-test-regex')?.addEventListener('click', async () => {
            const pattern = document.getElementById('regex-pattern').value;
            const testText = document.getElementById('regex-test-text').value;
            const resultEl = document.getElementById('regex-test-result');

            if (!pattern) {
                resultEl.innerHTML = '<p style="color: #f85149;">Please enter a regex pattern.</p>';
                return;
            }
            if (!testText) {
                resultEl.innerHTML = '<p style="color: #f85149;">Please enter test text.</p>';
                return;
            }

            try {
                const result = await window.pywebview.api.test_regex(pattern, testText);
                if (result.status === 'error') {
                    resultEl.innerHTML = `<p style="color: #f85149;">Error: ${result.detail}</p>`;
                } else if (result.matched) {
                    resultEl.innerHTML = `
                        <div style="color: #3fb950; margin-bottom: 12px; font-weight: bold;">✓ Match Found</div>
                        <div style="margin-bottom: 8px;"><strong>Matched Text:</strong> <code style="background: #21262d; padding: 2px 6px; border-radius: 3px;">${result.match_text}</code></div>
                        ${result.groups.length > 0 ? `<div style="margin-bottom: 8px;"><strong>Capture Groups:</strong> ${result.groups.map((g, i) => `<code style="background: #21262d; padding: 2px 6px; border-radius: 3px; margin-right: 4px;">${i + 1}: ${g}</code>`).join('')}</div>` : ''}
                        <div><strong>Position:</strong> ${result.span[0]} to ${result.span[1]}</div>
                    `;
                } else {
                    resultEl.innerHTML = '<div style="color: #f85149; font-weight: bold;">✗ No Match</div><p style="margin-top: 8px; color: #8b949e;">The pattern does not match the test text.</p>';
                }
            } catch (err) {
                resultEl.innerHTML = `<p style="color: #f85149;">Failed: ${err.message}</p>`;
            }
        });

        async function loadAppConfigs() {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.list_app_configs();
                const listEl = document.getElementById('app-config-list');
                if (result.status === 'success') {
                    if (result.configs.length === 0) {
                        listEl.innerHTML = '<p style="color: #8b949e;">No app-specific configs found.</p>';
                    } else {
                        listEl.innerHTML = result.configs.map(cfg => `
                            <div style="padding: 8px; border-bottom: 1px solid #30363d; margin-bottom: 8px;">
                                <div style="font-weight: bold; color: #58a6ff;">${cfg.name}.yml</div>
                                <div style="font-size: 12px; color: #8b949e; margin-top: 4px;">
                                    ${cfg.filter_exec ? `Executable: ${cfg.filter_exec}` : ''}
                                    ${cfg.filter_title ? ` | Title: ${cfg.filter_title}` : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    listEl.innerHTML = `<p style="color: #f85149;">Error: ${result.detail}</p>`;
                }
            } catch (err) {
                document.getElementById('app-config-list').innerHTML = '<p style="color: #f85149;">Failed: ' + err.message + '</p>';
            }
        }

        document.getElementById('btn-refresh-app-configs')?.addEventListener('click', loadAppConfigs);

        document.getElementById('btn-test-match')?.addEventListener('click', async () => {
            const input = document.getElementById('match-test-input').value;
            const resultEl = document.getElementById('match-test-result');
            if (!input) {
                resultEl.innerHTML = '<p style="color: #f85149;">Please enter text to test.</p>';
                return;
            }
            try {
                resultEl.innerHTML = '<p style="color: #8b949e;">Testing...</p>';
                const result = await window.pywebview.api.test_match(input);
                if (result.status === 'success' && result.matched) {
                    resultEl.innerHTML = `
                        <div class="match-result success">✓ Match Found</div>
                        <div style="margin-bottom: 6px;"><strong>Trigger:</strong> ${escapeHtml(result.input || input)}</div>
                        <div style="margin-bottom: 6px;"><strong>Output:</strong></div>
                        <pre class="code-block" style="margin:0;">${escapeHtml(result.output || '')}</pre>
                    `;
                    return;
                }
                if (result.matched === false) {
                    const detail = escapeHtml(result.detail || 'The provided text does not trigger any snippet.');
                    const stdout = result.stdout ? `<pre class="code-block" style="margin-top:8px;">${escapeHtml(result.stdout)}</pre>` : '';
                    resultEl.innerHTML = `
                        <div class="match-result warn">✗ No Match</div>
                        <div>${detail}</div>
                        ${stdout}
                    `;
                    return;
                }
                resultEl.innerHTML = `<p style="color: #f85149;">Error: ${escapeHtml(result.detail || 'Test failed')}</p>`;
            } catch (err) {
                resultEl.innerHTML = '<p style="color: #f85149;">Failed: ' + escapeHtml(err.message) + '</p>';
            }
        });

        document.getElementById('match-test-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('btn-test-match')?.click();
        });

        async function loadBackups() {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.list_backups();
                const listEl = document.getElementById('backup-list');
                if (result.status === 'success') {
                    if (result.backups.length === 0) {
                        listEl.innerHTML = '<p style="color: #8b949e;">No backups found. Create a backup to get started.</p>';
                    } else {
                        listEl.innerHTML = result.backups.map(backup => {
                            const date = new Date(backup.created * 1000).toLocaleString();
                            return `
                                <div style="padding: 12px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: bold; color: #58a6ff;">${backup.name}</div>
                                        <div style="font-size: 12px; color: #8b949e; margin-top: 4px;">${date}</div>
                                    </div>
                                    <button class="btn small" onclick="restoreBackup('${backup.name}')">Restore</button>
                                </div>
                            `;
                        }).join('');
                    }
                } else {
                    listEl.innerHTML = `<p style="color: #f85149;">Error: ${result.detail}</p>`;
                }
            } catch (err) {
                document.getElementById('backup-list').innerHTML = '<p style="color: #f85149;">Failed: ' + err.message + '</p>';
            }
        }

        async function restoreBackup(backupName) {
            if (!confirm(`Restore from "${backupName}"? This will replace your current config. Make sure you have a recent backup!`)) return;
            try {
                showToast('Restoring backup...');
                const result = await window.pywebview.api.restore_config(backupName);
                showToast(result.detail, result.status !== 'success');
                if (result.status === 'success') {
                    setTimeout(() => {
                        loadDashboard();
                        loadSnippetList();
                    }, 500);
                }
            } catch (err) {
                showToast('Restore failed: ' + err.message, true);
            }
        }

        window.restoreBackup = restoreBackup;

        document.getElementById('btn-create-backup')?.addEventListener('click', async () => {
            try {
                showToast('Creating backup...');
                const result = await window.pywebview.api.backup_config();
                showToast(result.detail, result.status !== 'success');
                if (result.status === 'success') await loadBackups();
            } catch (err) {
                showToast('Backup failed: ' + err.message, true);
            }
        });

        document.getElementById('btn-refresh-backups')?.addEventListener('click', loadBackups);

        function renderSnippetSenseSettings() {
            const statusEl = document.getElementById('snippetsense-status');
            const metaEl = document.getElementById('snippetsense-meta');
            const alertEl = document.getElementById('snippetsense-alert');
            const whitelistInput = document.getElementById('snippetsense-whitelist');
            const blacklistInput = document.getElementById('snippetsense-blacklist');
            const filterHint = document.getElementById('snippetsense-filter-hint');
            const settings = snippetSenseState.settings;
            if (!settings) {
                if (statusEl) statusEl.textContent = 'Unavailable';
                if (metaEl) metaEl.textContent = 'Settings not loaded.';
                return;
            }
            document.getElementById('snippetsense-enabled').checked = !!settings.enabled;
            document.getElementById('snippetsense-min-words').value = settings.min_words ?? 3;
            document.getElementById('snippetsense-min-chars').value = settings.min_chars ?? 10;
            document.getElementById('snippetsense-threshold').value = settings.repetition_threshold ?? 3;
            document.getElementById('snippetsense-whitelist').value = (settings.whitelist || []).join('\n');
            document.getElementById('snippetsense-blacklist').value = (settings.blacklist || []).join('\n');
            const available = snippetSenseState.available;
            const running = snippetSenseState.running;
            const filtersSupported = snippetSenseState.status?.appFiltersSupported !== false;
            if (whitelistInput) whitelistInput.disabled = !filtersSupported;
            if (blacklistInput) blacklistInput.disabled = !filtersSupported;
            if (filterHint) {
                filterHint.textContent = filtersSupported
                    ? 'Whitelist/blacklist limit monitoring to specific executables.'
                    : 'App filters are unavailable on this OS, so SnippetSense monitors all applications.';
            }
            if (statusEl) {
                if (!available) {
                    statusEl.textContent = 'Unavailable (pynput not installed)';
                } else if (running) {
                    statusEl.textContent = 'Running';
                } else if (settings.enabled) {
                    statusEl.textContent = 'Starting...';
                } else {
                    statusEl.textContent = 'Disabled';
                }
            }
            if (metaEl) {
                const pendingCount = snippetSenseState.pending.length;
                metaEl.textContent = `Pending suggestions: ${pendingCount}`;
            }
            if (alertEl) {
                const error = snippetSenseState.status?.error;
                if (!available || error) {
                    alertEl.style.display = 'block';
                    alertEl.textContent = error || 'SnippetSense requires additional dependencies (pynput, psutil).';
                } else {
                    alertEl.style.display = 'none';
                }
            }
        }

        function renderSnippetSenseSuggestions() {
            const container = document.getElementById('snippetsense-suggestions');
            if (!container) return;
            const suggestions = snippetSenseState.pending || [];
            if (!suggestions.length) {
                container.innerHTML = '<p style="color: #8b949e; font-size: 13px;">No suggestions yet.</p>';
                return;
            }
            container.innerHTML = suggestions.map(item => `
                <div class="help-card" data-suggestion-id="${item.id}">
                    <h4>${escapeHtml(item.phrase || '(unknown phrase)')}</h4>
                    <ul>
                        <li>Seen ${item.count || 0} time(s)</li>
                        <li>Hash: ${escapeHtml(item.hash || '').slice(0, 10)}...</li>
                    </ul>
                    <div class="helper-actions">
                        <button class="btn small" data-suggestion-action="accept" data-suggestion-id="${item.id}">Accept</button>
                        <button class="btn small secondary" data-suggestion-action="reject" data-suggestion-id="${item.id}">Reject</button>
                        <button class="btn small danger" data-suggestion-action="never" data-suggestion-id="${item.id}">Never</button>
                    </div>
                </div>
            `).join('');
        }

        function parseLineList(value = '') {
            return value.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
        }

        function manageSnippetSensePolling() {
            const shouldPoll = snippetSenseState.settings?.enabled && snippetSenseState.running;
            if (shouldPoll && !snippetSensePollTimer) {
                snippetSensePollTimer = setInterval(() => refreshSnippetSenseSuggestions(), 15000);
            } else if (!shouldPoll && snippetSensePollTimer) {
                clearInterval(snippetSensePollTimer);
                snippetSensePollTimer = null;
            }
        }

        function showSnippetSensePrompt(suggestion) {
            const container = document.getElementById('snippetsense-toast-container');
            if (!container || snippetSenseState.toastIds.has(suggestion.id)) return;
            snippetSenseState.toastIds.add(suggestion.id);
            const el = document.createElement('div');
            el.className = 'snippetsense-toast';
            el.dataset.suggestionId = suggestion.id;
            el.innerHTML = `
                <strong>Suggested snippet?</strong>
                <div style="font-size: 13px;">${escapeHtml(suggestion.phrase || '')}</div>
                <div class="snippetsense-toast-actions">
                    <button class="btn small" data-suggestion-action="accept" data-suggestion-id="${suggestion.id}">Yes</button>
                    <button class="btn small secondary" data-suggestion-action="reject" data-suggestion-id="${suggestion.id}">No</button>
                    <button class="btn small danger" data-suggestion-action="never" data-suggestion-id="${suggestion.id}">Never</button>
                </div>
            `;
            container.appendChild(el);
            setTimeout(() => {
                if (container.contains(el)) {
                    container.removeChild(el);
                    snippetSenseState.toastIds.delete(suggestion.id);
                }
            }, 20000);
        }

        async function loadSnippetSenseState() {
            if (!isWebview()) return;
            try {
                const response = await window.pywebview.api.get_snippetsense_state();
                snippetSenseState.settings = response.settings || {};
                snippetSenseState.pending = response.pending || [];
                snippetSenseState.available = response.status?.available !== false;
                snippetSenseState.running = !!response.status?.running;
                snippetSenseState.status = response.status || {};
                renderSnippetSenseSettings();
                renderSnippetSenseSuggestions();
                manageSnippetSensePolling();
            } catch (err) {
                const alertEl = document.getElementById('snippetsense-alert');
                if (alertEl) {
                    alertEl.style.display = 'block';
                    alertEl.textContent = 'Failed to load SnippetSense: ' + err.message;
                }
            }
        }

        async function saveSnippetSenseSettings() {
            if (!isWebview()) return;
            const payload = {
                enabled: document.getElementById('snippetsense-enabled').checked,
                min_words: Number(document.getElementById('snippetsense-min-words').value) || 3,
                min_chars: Number(document.getElementById('snippetsense-min-chars').value) || 10,
                repetition_threshold: Number(document.getElementById('snippetsense-threshold').value) || 3,
                whitelist: parseLineList(document.getElementById('snippetsense-whitelist').value),
                blacklist: parseLineList(document.getElementById('snippetsense-blacklist').value)
            };
            try {
                const result = await window.pywebview.api.save_snippetsense_settings(payload);
                snippetSenseState.settings = result.settings;
                showToast(result.detail || 'SnippetSense settings saved');
                await loadSnippetSenseState();
            } catch (err) {
                showToast('Failed to save SnippetSense settings: ' + err.message, true);
            }
        }

        async function refreshSnippetSenseSuggestions(showToastMessage = false) {
            if (!isWebview()) return;
            try {
                const response = await window.pywebview.api.list_snippetsense_suggestions();
                const oldIds = new Set((snippetSenseState.pending || []).map(item => item.id));
                snippetSenseState.pending = response.pending || [];
                renderSnippetSenseSuggestions();
                manageSnippetSensePolling();
                (snippetSenseState.pending || []).forEach(suggestion => {
                    if (!oldIds.has(suggestion.id)) {
                        showSnippetSensePrompt(suggestion);
                    }
                });
                if (showToastMessage) {
                    showToast(`Loaded ${snippetSenseState.pending.length} suggestion(s)`);
                }
            } catch (err) {
                if (showToastMessage) {
                    showToast('Failed to refresh suggestions: ' + err.message, true);
                }
            }
        }

        async function handleSnippetSenseDecision(id, decision) {
            if (!id || !isWebview()) return;
            try {
                const result = await window.pywebview.api.handle_snippetsense_decision(id, decision);
                showToast(result.detail || 'Updated');
                if (decision === 'accept') {
                    await loadSnippetList(false);
                    const snippetPayload = result.snippet;
                    const targetTrigger = result.trigger || (snippetPayload && snippetPayload.trigger);
                    if (snippetPayload) {
                        const listMeta = snippetState.list.find(item => item.trigger === snippetPayload.trigger) || {};
                        hydrateSnippetEditor(snippetPayload, listMeta);
                        switchView('snippet');
                    } else if (targetTrigger) {
                        switchView('snippet');
                        setTimeout(() => selectSnippet(targetTrigger), 200);
                    }
                }
                await refreshSnippetSenseSuggestions();
            } catch (err) {
                showToast('Failed to update suggestion: ' + err.message, true);
            }
        }

        function loadDoctorDiagnostics() {
            const output = document.getElementById('doctor-output');
            if (output) output.textContent = 'Click "Run Diagnostics" to check your Espanso installation.';
        }

        async function runDoctorDiagnostics(auto = false) {
            if (!isWebview()) return;
            if (diagnosticsInProgress) {
                if (!auto) {
                    showToast('Diagnostics are already running', true);
                }
                return;
            }
            diagnosticsInProgress = true;
            const output = document.getElementById('doctor-output');
            const dashboardPanel = document.getElementById('dashboard-diagnostic-preview');
            if (output && !auto) output.textContent = 'Running diagnostics...';
            if (dashboardPanel) dashboardPanel.textContent = 'Running diagnostics...';
            try {
                const result = await window.pywebview.api.doctor_diagnostics();
                const text = (result.output || 'Diagnostics completed with no output.').trim();
                if (output) output.textContent = text;
                if (dashboardPanel) dashboardPanel.textContent = text;
                lastDiagnosticsRun = Date.now();
                if (!auto) {
                    if (result.status === 'success' && result.exit_code == 0) {
                        showToast('Diagnostics completed successfully');
                    } else {
                        showToast(result.detail || 'Diagnostics finished with warnings', true);
                    }
                }
            } catch (err) {
                const failure = 'Failed to run diagnostics: ' + err.message;
                if (output) output.textContent = failure;
                if (dashboardPanel) dashboardPanel.textContent = failure;
                if (!auto) showToast(failure, true);
            } finally {
                diagnosticsInProgress = false;
            }
        }

        document.getElementById('btn-run-doctor')?.addEventListener('click', () => runDoctorDiagnostics(false));

        document.getElementById('btn-load-template')?.addEventListener('click', async () => {
            const templateSelect = document.getElementById('app-template-select');
            const appNameInput = document.getElementById('app-name-input');
            const filterExecInput = document.getElementById('filter-exec-input');
            if (!templateSelect || !appNameInput || !filterExecInput) return;

            const templateName = templateSelect.value;
            if (!templateName) {
                appNameInput.value = '';
                filterExecInput.value = '';
                showToast('Template cleared');
                return;
            }

            try {
                const result = await window.pywebview.api.get_app_config_templates();
                if (result.status === 'success' && result.templates[templateName]) {
                    const template = result.templates[templateName];
                    appNameInput.value = templateName;
                    filterExecInput.value = template.filter_exec;
                    showToast(`Loaded ${templateName} template`);
                } else {
                    showToast('Template not found', true);
                }
            } catch (err) {
                showToast('Failed to load template: ' + err.message, true);
            }
        });

        async function loadSnippetIDE() {
            if (!isWebview()) {
                snippetListEl.innerHTML = '<p style="color: #8b949e;">Not connected.</p>';
                return;
            }
            await Promise.all([loadSnippetList(), loadVariableTypes(), loadGlobalVars()]);
            renderReplacementPreview();
        }

        async function loadSnippetList(runSearch = true) {
            try {
                const snippets = await window.pywebview.api.list_snippets();
                snippetState.list = snippets || [];
                updateSnippetFileOptions();
                if (!snippetSearchState.query && !filtersActive()) {
                    snippetSearchState.results = snippetState.list;
                    snippetSearchState.total = snippetState.list.length;
                    updateSnippetSearchSummary();
                }
                renderSnippetList();
                if (runSearch) {
                    await performSnippetSearch();
                }
                updateQuickInsertResults();
            } catch (err) {
                showToast('Failed to load snippets: ' + err.message, true);
            }
        }

        const pagination = {page: 0, pageSize: 50};

        function renderSnippetList() {
            if (!snippetListEl) return;
            const dataset = (snippetSearchState.results.length || filtersActive())
                ? snippetSearchState.results
                : snippetState.list;
            if (!dataset || !dataset.length) {
                const message = snippetState.list.length
                    ? 'No snippets match the current filters.'
                    : 'Load snippets from the toolbar.';
                snippetListEl.innerHTML = `<p style="color:#8b949e;">${message}</p>`;
                return;
            }
            const totalPages = Math.ceil(dataset.length / pagination.pageSize);
            const start = pagination.page * pagination.pageSize;
            const pageData = dataset.slice(start, start + pagination.pageSize);
            const query = snippetSearchState.query;
            const paginationHtml = totalPages > 1 ? `
                <div style="padding: 8px; display: flex; gap: 8px; align-items: center; justify-content: center; border-top: 1px solid #30363d;">
                    <button class="btn small" ${pagination.page === 0 ? 'disabled' : ''} onclick="pagination.page--; renderSnippetList();">Previous</button>
                    <span style="color: #8b949e;">Page ${pagination.page + 1} of ${totalPages} (${dataset.length} total)</span>
                    <button class="btn small" ${pagination.page >= totalPages - 1 ? 'disabled' : ''} onclick="pagination.page++; renderSnippetList();">Next</button>
                </div>
            ` : '';
            snippetListEl.innerHTML = pageData.map(snippet => {
                const active = snippet.trigger === snippetState.currentTrigger ? 'active' : '';
                const disabledClass = snippet.enabled === false ? 'disabled' : '';
                const isSelected = selectedSnippets.has(snippet.trigger);
                const metaBits = [escapeHtml(snippet.file || 'base.yml')];
                if (snippet.hasVars) metaBits.push('vars');
                if (snippet.hasForm) metaBits.push('forms');
                if (snippet.backend) metaBits.push(`backend:${escapeHtml(snippet.backend)}`);
                if (typeof snippet.delay === 'number') metaBits.push(`${snippet.delay}ms`);
                if (snippet.image_path) metaBits.push('image');
                if (snippet.enabled === false) metaBits.push('disabled');
                const labelHighlightQuery = snippetSearchState.filters.label || query;
                const labelHtml = snippet.label
                    ? `<div class="snippet-meta">${highlightMatch(snippet.label, labelHighlightQuery)}</div>`
                    : '';
                return `
                    <div class="snippet-card ${active} ${disabledClass}" data-trigger="${escapeHtml(snippet.trigger || '')}">
                        <div class="selection-checkbox" title="Toggle selection for bulk operations">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSnippetSelection('${escapeHtml(snippet.trigger)}', this.checked)" onclick="event.stopPropagation();" onpointerdown="event.stopPropagation();" onkeydown="event.stopPropagation();">
                        </div>
                        <div class="snippet-trigger">${highlightMatch(snippet.trigger || '(no trigger)', query)}</div>
                        <div class="snippet-preview">${highlightMatch(snippet.replace || '(no replacement)', query)}</div>
                        <div class="snippet-meta">${metaBits.filter(Boolean).join(' • ')}</div>
                        ${labelHtml}
                    </div>
                `;
            }).join('') + paginationHtml;
        }

        function filtersActive() {
            const filters = snippetSearchState.filters;
            return Boolean(
                (snippetSearchState.query || '').trim() ||
                filters.file ||
                filters.enabled ||
                filters.label ||
                filters.hasVars ||
                filters.hasForm
            );
        }

        function updateSnippetFileOptions() {
            if (!snippetFileFilter) return;
            const files = Array.from(
                new Set((snippetState.list || []).map(snippet => snippet.file || 'base.yml'))
            ).sort();
            const options = ['<option value="">All files</option>']
                .concat(files.map(file => `<option value="${escapeHtml(file)}">${escapeHtml(file)}</option>`))
                .join('');
            snippetFileFilter.innerHTML = options;
            snippetFileFilter.value = snippetSearchState.filters.file || '';
        }

        function updateSnippetSearchSummary() {
            if (!snippetSearchSummary) return;
            const total = snippetSearchState.total || snippetState.list.length || 0;
            if (!total) {
                snippetSearchSummary.textContent = 'No snippets loaded.';
                return;
            }
            snippetSearchSummary.textContent = `Showing ${snippetSearchState.results.length} of ${total} snippets`;
        }

        function quickInsertMatches(snippet, query) {
            if (!query) return true;
            const haystack = [
                snippet.trigger || '',
                snippet.replace || '',
                snippet.label || '',
                snippet.file || ''
            ].join(' ').toLowerCase();
            return haystack.includes(query);
        }

        function showQuickInsertPreview(snippet) {
            if (!quickInsertPreviewEl) return;
            if (!snippet) {
                quickInsertPreviewEl.innerHTML = '<p style="color:#8b949e;">Hover a snippet to preview it.</p>';
                return;
            }
            const metaBits = [];
            if (snippet.backend) metaBits.push(`Backend: ${snippet.backend}`);
            if (typeof snippet.delay === 'number') metaBits.push(`Delay: ${snippet.delay} ms`);
            if (snippet.image_path) metaBits.push(`Image: ${snippet.image_path}`);
            quickInsertPreviewEl.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <div style="font-weight:600; font-size: 16px;">${escapeHtml(snippet.trigger || '(no trigger)')}</div>
                    <div style="font-size: 12px; color: #8b949e;">${escapeHtml(snippet.file || 'base.yml')} • ${snippet.enabled === false ? 'Disabled' : 'Enabled'}</div>
                </div>
                ${snippet.label ? `<div style="margin-bottom:8px; color:#8b949e;">${escapeHtml(snippet.label)}</div>` : ''}
                ${metaBits.length ? `<div style="font-size:12px; color:#6e7681; margin-bottom:8px;">${escapeHtml(metaBits.join(' • '))}</div>` : ''}
                <pre style="margin:0; white-space:pre-wrap; font-family:inherit;">${escapeHtml(snippet.replace || '(no replacement)')}</pre>
            `;
        }

        function updateQuickInsertResults() {
            if (!quickInsertResultsEl) return;
            const dataset = snippetState.list || [];
            const query = (quickInsertState.query || '').trim().toLowerCase();
            const filtered = dataset.filter(snippet => quickInsertMatches(snippet, query)).slice(0, 200);
            quickInsertState.results = filtered;
            if (!filtered.length) {
                const message = dataset.length ? 'No snippets match this search.' : 'No snippets loaded yet.';
                quickInsertResultsEl.innerHTML = `<p style="color:#8b949e;">${message}</p>`;
                showQuickInsertPreview(null);
                return;
            }
            quickInsertResultsEl.innerHTML = filtered.map((snippet, index) => {
                const metaParts = [];
                if (snippet.enabled === false) metaParts.push('disabled');
                if (snippet.hasVars) metaParts.push('vars');
                if (snippet.hasForm) metaParts.push('forms');
                const meta = metaParts.length ? `<div class="quick-snippet-meta">${escapeHtml(metaParts.join(' • '))}</div>` : '';
                return `
                    <div class="quick-snippet-card" data-trigger="${escapeHtml(snippet.trigger || '')}" data-index="${index}" tabindex="0" title="Click to copy. Double-click to edit in the IDE.">
                        <div class="quick-snippet-trigger">
                            <span>${highlightMatch(snippet.trigger || '(no trigger)', quickInsertState.query)}</span>
                            <small style="color:#8b949e;">${escapeHtml(snippet.file || 'base.yml')}</small>
                        </div>
                        ${snippet.label ? `<div class="quick-snippet-label">${highlightMatch(snippet.label, quickInsertState.query)}</div>` : ''}
                        ${meta}
                    </div>
                `;
            }).join('');
            showQuickInsertPreview(filtered[0]);
        }

        async function copyTriggerToClipboard(trigger) {
            if (!trigger) return;
            try {
                if (navigator.clipboard?.writeText) {
                    await navigator.clipboard.writeText(trigger);
                } else {
                    const temp = document.createElement('textarea');
                    temp.value = trigger;
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand('copy');
                    document.body.removeChild(temp);
                }
                showToast(`Copied ${trigger} to clipboard`);
            } catch (err) {
                showToast('Copy failed: ' + err.message, true);
            }
        }

        function jumpToSnippetFromQuick(trigger) {
            if (!trigger) return;
            switchView('snippet');
            setTimeout(() => selectSnippet(trigger), 150);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function performSnippetSearch() {
            if (!isWebview()) {
                snippetSearchState.results = snippetState.list;
                snippetSearchState.total = snippetState.list.length;
                renderSnippetList();
                updateSnippetSearchSummary();
                return;
            }
            try {
                const response = await window.pywebview.api.search_snippets(
                    snippetSearchState.query || '',
                    snippetSearchState.filters
                );
                if (response.status === 'success') {
                    snippetSearchState.results = response.results || [];
                    snippetSearchState.total = typeof response.total === 'number'
                        ? response.total
                        : (snippetState.list.length || 0);
                    renderSnippetList();
                    updateSnippetSearchSummary();
                } else {
                    showToast(response.detail || 'Snippet search failed', true);
                }
            } catch (err) {
                showToast('Failed to search snippets: ' + err.message, true);
            }
        }

        function updateSnippetMetaSummary(snippet = null) {
            const target = document.getElementById('snippet-meta-summary');
            if (!snippet) {
                target.textContent = 'No snippet selected.';
                return;
            }
            const rows = [];
            if (snippet.trigger) rows.push(`Trigger: ${snippet.trigger}`);
            if (snippet.file) rows.push(`File: ${snippet.file}`);
            rows.push(`Enabled: ${snippet.enabled === false ? 'no' : 'yes'}`);
            rows.push(`Word boundary: ${snippet.word ? 'yes' : 'no'}`);
            rows.push(`Propagate case: ${snippet.propagate_case ? 'yes' : 'no'}`);
            if (snippet.label) rows.push(`Label: ${snippet.label}`);
            if (snippet.backend) rows.push(`Backend: ${snippet.backend}`);
            if (typeof snippet.delay === 'number') rows.push(`Delay: ${snippet.delay} ms`);
            rows.push(`Left boundary: ${snippet.left_word ? 'yes' : 'no'}`);
            rows.push(`Right boundary: ${snippet.right_word ? 'yes' : 'no'}`);
            if (snippet.uppercase_style) rows.push(`Uppercase style: ${snippet.uppercase_style}`);
            if (snippet.image_path) rows.push(`Image: ${snippet.image_path}`);
            if (snippet.hasVars || (snippet.vars && snippet.vars.length)) {
                rows.push(`Variables: ${snippet.vars?.length || snippet.variableCount || 0}`);
            }
            target.innerHTML = rows.map(row => `<div>${escapeHtml(row)}</div>`).join('');
        }

        function renderReplacementPreview() {
            const raw = document.getElementById('snippet-replace').value || '';
            const normalized = raw.replace(/\r\n/g, '\n');
            const highlighted = escapeHtml(normalized)
                .replace(/\$\|\$/g, '<span class="cursor-marker">$|$</span>')
                .replace(/\n/g, '<br>');
            document.getElementById('snippet-preview').innerHTML = highlighted || '<p style="color:#8b949e; font-size:13px;">Start typing to preview rich text output.</p>';
        }

        snippetListEl.addEventListener('click', event => {
            const card = event.target.closest('.snippet-card');
            if (card) {
                selectSnippet(card.dataset.trigger);
                switchView('snippet');
            }
        });

        const debouncedSearch = debounce(performSnippetSearch, 300);

        if (snippetSearchInput) {
            snippetSearchInput.addEventListener('input', e => {
                snippetSearchState.query = e.target.value || '';
                debouncedSearch();
            });
        }

        if (snippetFileFilter) {
            snippetFileFilter.addEventListener('change', e => {
                snippetSearchState.filters.file = e.target.value || '';
                performSnippetSearch();
            });
        }

        if (snippetEnabledFilter) {
            snippetEnabledFilter.addEventListener('change', e => {
                snippetSearchState.filters.enabled = e.target.value || '';
                performSnippetSearch();
            });
        }

        if (snippetVarsFilter) {
            snippetVarsFilter.addEventListener('change', e => {
                snippetSearchState.filters.hasVars = e.target.checked;
                performSnippetSearch();
            });
        }

        if (snippetFormsFilter) {
            snippetFormsFilter.addEventListener('change', e => {
                snippetSearchState.filters.hasForm = e.target.checked;
                performSnippetSearch();
            });
        }

        if (snippetLabelFilter) {
            snippetLabelFilter.addEventListener('input', e => {
                snippetSearchState.filters.label = e.target.value || '';
                debouncedSearch();
            });
        }

        const clearFiltersBtn = document.getElementById('btn-clear-snippet-filters');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                snippetSearchState.query = '';
                snippetSearchState.filters = {
                    file: '',
                    enabled: '',
                    hasVars: false,
                    hasForm: false,
                    label: ''
                };
                if (snippetSearchInput) snippetSearchInput.value = '';
                if (snippetFileFilter) snippetFileFilter.value = '';
                if (snippetEnabledFilter) snippetEnabledFilter.value = '';
                if (snippetVarsFilter) snippetVarsFilter.checked = false;
                if (snippetFormsFilter) snippetFormsFilter.checked = false;
                if (snippetLabelFilter) snippetLabelFilter.value = '';
                performSnippetSearch();
            });
        }

        function quickInsertCardSnippet(card) {
            if (!card) return null;
            const index = Number(card.dataset.index);
            return quickInsertState.results[index];
        }

        const handleQuickHover = (event) => {
            const card = event.target.closest('.quick-snippet-card');
            if (!card) return;
            const snippet = quickInsertCardSnippet(card);
            if (snippet) showQuickInsertPreview(snippet);
        };

        quickInsertResultsEl?.addEventListener('mouseover', handleQuickHover);
        quickInsertResultsEl?.addEventListener('focusin', handleQuickHover);
        quickInsertResultsEl?.addEventListener('click', event => {
            const card = event.target.closest('.quick-snippet-card');
            if (!card) return;
            event.preventDefault();
            copyTriggerToClipboard(card.dataset.trigger);
        });
        quickInsertResultsEl?.addEventListener('dblclick', event => {
            const card = event.target.closest('.quick-snippet-card');
            if (!card) return;
            event.preventDefault();
            jumpToSnippetFromQuick(card.dataset.trigger);
        });
        quickInsertResultsEl?.addEventListener('keydown', event => {
            const card = event.target.closest('.quick-snippet-card');
            if (!card) return;
            if (event.key === 'Enter') {
                event.preventDefault();
                copyTriggerToClipboard(card.dataset.trigger);
            } else if (event.key === ' ') {
                event.preventDefault();
                showQuickInsertPreview(quickInsertCardSnippet(card));
            }
        });
        quickInsertInput?.addEventListener('input', e => {
            quickInsertState.query = e.target.value || '';
            updateQuickInsertResults();
        });
        quickInsertClearBtn?.addEventListener('click', () => {
            if (quickInsertInput) {
                quickInsertInput.value = '';
                quickInsertInput.focus();
            }
            quickInsertState.query = '';
            updateQuickInsertResults();
        });

        function hydrateSnippetEditor(snippet, metaOverrides = {}) {
            if (!snippet) return;
            snippetState.currentTrigger = snippet.trigger;
            document.getElementById('snippet-trigger').value = snippet.trigger || '';
            document.getElementById('snippet-replace').value = snippet.replace || '';
            document.getElementById('snippet-word').checked = !!snippet.word;
            document.getElementById('snippet-propagate-case').checked = !!snippet.propagate_case;
            if (snippetLabelInput) snippetLabelInput.value = snippet.label || '';
            if (snippetEnabledInput) snippetEnabledInput.checked = snippet.enabled !== false;
            if (snippetBackendSelect) snippetBackendSelect.value = snippet.backend || '';
            if (snippetDelayInput) snippetDelayInput.value = typeof snippet.delay === 'number' ? snippet.delay : '';
            if (snippetLeftWordInput) snippetLeftWordInput.checked = !!snippet.left_word;
            if (snippetRightWordInput) snippetRightWordInput.checked = !!snippet.right_word;
            if (snippetUppercaseStyleSelect) snippetUppercaseStyleSelect.value = snippet.uppercase_style || '';
            if (snippetImagePathInput) snippetImagePathInput.value = snippet.image_path || '';
            updateImagePreview(true);
            snippetState.vars = (snippet.vars || []).map(v => ({ ...v }));
            renderVariableList();
            renderSnippetList();
            document.getElementById('snippet-status').textContent = snippet.trigger
                ? `Editing ${snippet.trigger}`
                : 'New snippet';
            renderReplacementPreview();
            const meta = { ...snippet, ...metaOverrides };
            updateSnippetMetaSummary(meta);
        }

        async function selectSnippet(trigger) {
            if (!isWebview()) return;
            try {
                const result = await window.pywebview.api.get_snippet(trigger);
                if (result.status === 'success') {
                    const snippet = result.snippet;
                    const listMeta = snippetState.list.find(item => item.trigger === snippet.trigger) || {};
                    hydrateSnippetEditor(snippet, listMeta);
                } else {
                    showToast(result.detail, true);
                }
            } catch (err) {
                showToast('Failed to load snippet: ' + err.message, true);
            }
        }

        function resetSnippetForm() {
            snippetState.currentTrigger = null;
            snippetState.vars = [];
            document.getElementById('snippet-trigger').value = '';
            document.getElementById('snippet-replace').value = '';
            document.getElementById('snippet-word').checked = false;
            document.getElementById('snippet-propagate-case').checked = false;
            if (snippetLabelInput) snippetLabelInput.value = '';
            if (snippetEnabledInput) snippetEnabledInput.checked = true;
            if (snippetBackendSelect) snippetBackendSelect.value = '';
            if (snippetDelayInput) snippetDelayInput.value = '';
            if (snippetLeftWordInput) snippetLeftWordInput.checked = false;
            if (snippetRightWordInput) snippetRightWordInput.checked = false;
            if (snippetUppercaseStyleSelect) snippetUppercaseStyleSelect.value = '';
            if (snippetImagePathInput) snippetImagePathInput.value = '';
            document.getElementById('snippet-status').textContent = 'New snippet';
            renderVariableList();
            renderSnippetList();
            renderReplacementPreview();
            updateSnippetMetaSummary();
            updateImagePreview(true);
        }

        document.getElementById('btn-new-snippet').addEventListener('click', resetSnippetForm);
        document.getElementById('snippet-replace').addEventListener('input', renderReplacementPreview);
        document.getElementById('btn-insert-cursor').addEventListener('click', () => insertLiteralAtCursor('$|$'));
        snippetImagePathInput?.addEventListener('input', scheduleImagePreviewUpdate);
        snippetImagePathInput?.addEventListener('blur', () => updateImagePreview(true));
        if (snippetImagePreviewEl) {
            ['dragenter', 'dragover'].forEach(evt => snippetImagePreviewEl.addEventListener(evt, handleImageDragOver));
            ['dragleave', 'dragend'].forEach(evt => snippetImagePreviewEl.addEventListener(evt, handleImageDragLeave));
            snippetImagePreviewEl.addEventListener('drop', handleImageDrop);
        }

        function renderVariableList() {
            if (!snippetState.vars.length) {
                variableListEl.innerHTML = '<p style="color:#8b949e; font-size:13px;">No variables yet.</p>';
                return;
            }
            variableListEl.innerHTML = snippetState.vars.map((variable, index) => `
                <div class="variable-card">
                    <div class="variable-info">
                        <div class="variable-name">{{${escapeHtml(variable.name || '')}}}</div>
                        <div class="variable-type">${escapeHtml(variable.type || '')}</div>
                    </div>
                    <div class="variable-actions">
                        <button class="btn small secondary" data-action="insert" data-index="${index}">Insert</button>
                        <button class="btn small" data-action="edit" data-index="${index}">Edit</button>
                        <button class="btn small danger" data-action="delete" data-index="${index}">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        variableListEl.addEventListener('click', event => {
            const action = event.target.dataset.action;
            if (!action) return;
            const index = Number(event.target.dataset.index);
            if (Number.isNaN(index)) return;
            if (action === 'insert') {
                const name = snippetState.vars[index]?.name;
                if (name) insertVariableAtCursor(name);
            } else if (action === 'edit') {
                openVariableModal('edit', index);
            } else if (action === 'delete') {
                snippetState.vars.splice(index, 1);
                renderVariableList();
            }
        });

        function insertLiteralAtCursor(value) {
            const textarea = document.getElementById('snippet-replace');
            const start = typeof textarea.selectionStart === 'number' ? textarea.selectionStart : textarea.value.length;
            const end = typeof textarea.selectionEnd === 'number' ? textarea.selectionEnd : textarea.value.length;
            const current = textarea.value;
            textarea.value = current.slice(0, start) + value + current.slice(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + value.length;
            renderReplacementPreview();
        }

        function insertVariableAtCursor(name) {
            insertLiteralAtCursor(`{{${name}}}`);
        }

        document.getElementById('btn-add-var').addEventListener('click', () => openVariableModal('add'));

        function openVariableModal(mode, index = null, presetType = null) {
            if (!snippetState.variableTypes.length) {
                showToast('Variable metadata not loaded yet', true);
                return;
            }
            snippetState.modalMode = mode;
            snippetState.editingVarIndex = index;
            const select = document.getElementById('var-type');
            select.innerHTML = snippetState.variableTypes.map(type => `<option value="${type.type}">${type.label}</option>`).join('');
            if (mode === 'edit' && typeof index === 'number') {
                const variable = snippetState.vars[index];
                document.getElementById('variable-modal-title').textContent = `Edit ${variable.name}`;
                document.getElementById('var-name').value = variable.name || '';
                select.value = variable.type;
                renderVariableParamFields(variable.type, variable.params || {});
            } else {
                document.getElementById('variable-modal-title').textContent = 'Add Variable';
                document.getElementById('var-name').value = '';
                const startingType = presetType || select.value;
                select.value = startingType;
                renderVariableParamFields(startingType, {});
            }
            variableModal.classList.add('active');
        }

        document.getElementById('close-variable-modal').addEventListener('click', closeVariableModal);
        document.getElementById('btn-cancel-variable').addEventListener('click', closeVariableModal);
        function closeVariableModal() {
            variableModal.classList.remove('active');
        }

        document.getElementById('var-type').addEventListener('change', event => {
            renderVariableParamFields(event.target.value, {});
        });

        function renderVariableParamFields(typeName, values) {
            const container = document.getElementById('variable-params');
            const typeMeta = snippetState.variableTypes.find(t => t.type === typeName);
            const params = typeMeta ? typeMeta.params : [];
            if (!params.length) {
                container.innerHTML = '<p style="color:#8b949e; font-size:12px;">No parameters required.</p>';
                toggleHelperPanels(typeName);
                return;
            }
            container.innerHTML = params.map(param => {
                const config = PARAM_CONFIG[param] || { label: param };
                const value = values[param] ?? '';
                if (config.type === 'textarea') {
                    return `
                        <div class="input-group">
                            <label>${config.label}</label>
                            <textarea data-param="${param}" data-type="${config.dataType || 'text'}" rows="3" placeholder="${config.placeholder || ''}">${Array.isArray(value) ? value.join('\n') : value}</textarea>
                            ${config.helper ? `<small style="color:#6e7681;">${config.helper}</small>` : ''}
                        </div>
                    `;
                }
                if (config.type === 'number') {
                    return `
                        <div class="input-group">
                            <label>${config.label}</label>
                            <input type="number" data-param="${param}" data-type="number" value="${value || ''}">
                        </div>
                    `;
                }
                if (config.type === 'datetime') {
                    return `
                        <div class="input-group">
                            <label>${config.label}</label>
                            <input type="datetime-local" data-param="${param}" data-type="datetime" value="${value || ''}">
                        </div>
                    `;
                }
                return `
                    <div class="input-group">
                        <label>${config.label}</label>
                        <input type="text" data-param="${param}" data-type="text" value="${Array.isArray(value) ? value.join(', ') : value}" placeholder="${config.placeholder || ''}">
                    </div>
                `;
            }).join('');
            toggleHelperPanels(typeName);
        }

        function toggleHelperPanels(typeName) {
            if (shellHelperPanel) {
                shellHelperPanel.classList.toggle('active', typeName === 'shell');
                if (typeName !== 'shell' && shellTestResultEl) {
                    shellTestResultEl.textContent = 'Output will appear here.';
                }
            }
            if (dateHelperPanel) {
                const isDate = typeName === 'date';
                dateHelperPanel.classList.toggle('active', isDate);
                if (!isDate && dateHelperOutputEl) {
                    dateHelperOutputEl.textContent = 'Preview will appear here.';
                }
            }
        }

        function getParamInput(paramName) {
            return document.querySelector(`#variable-params [data-param="${paramName}"]`);
        }

        function insertShellTemplate(template) {
            if (!template) return;
            const cmdInput = getParamInput('cmd');
            if (!cmdInput) {
                showToast('Open a shell variable to use helpers', true);
                return;
            }
            const start = cmdInput.selectionStart ?? cmdInput.value.length;
            const end = cmdInput.selectionEnd ?? cmdInput.value.length;
            const value = cmdInput.value || '';
            cmdInput.value = value.slice(0, start) + template + value.slice(end);
            cmdInput.selectionStart = cmdInput.selectionEnd = start + template.length;
            cmdInput.focus();
        }

        async function testShellCommand() {
            if (!isWebview()) {
                showToast('Shell testing requires the desktop app', true);
                return;
            }
            const cmdInput = getParamInput('cmd');
            if (!cmdInput || !cmdInput.value.trim()) {
                showToast('Enter a shell command first', true);
                return;
            }
            const shellInput = getParamInput('shell');
            const useShell = shellInput ? shellInput.value.trim().toLowerCase() !== 'false' : true;
            const timeout = parseInt(shellTimeoutInput?.value || '5', 10) || 5;
            if (shellTestResultEl) shellTestResultEl.textContent = 'Running...';
            try {
                const result = await window.pywebview.api.test_shell_command(cmdInput.value, timeout, useShell);
                if (result.status === 'success') {
                    if (shellTestResultEl) shellTestResultEl.textContent = result.output || '(no output)';
                    showToast('Command completed');
                } else {
                    if (shellTestResultEl) shellTestResultEl.textContent = result.detail || 'Command failed';
                    showToast(result.detail || 'Command failed', true);
                }
            } catch (err) {
                if (shellTestResultEl) shellTestResultEl.textContent = err.message;
                showToast('Command failed: ' + err.message, true);
            }
        }

        async function applyDateOffset() {
            if (!isWebview()) {
                showToast('Date helpers require the desktop app', true);
                return;
            }
            const formatInput = getParamInput('format');
            const offsetInput = getParamInput('offset');
            if (!formatInput) {
                showToast('Select the Date variable first', true);
                return;
            }
            const expression = (dateOffsetExpressionInput?.value || '').trim();
            if (dateHelperOutputEl) dateHelperOutputEl.textContent = 'Calculating...';
            try {
                const result = await window.pywebview.api.preview_date_offset(formatInput.value || '%Y-%m-%d', expression);
                if (result.status === 'success') {
                    if (dateHelperOutputEl) dateHelperOutputEl.textContent = `Preview: ${result.preview}`;
                    if (typeof result.seconds === 'number' && offsetInput) {
                        offsetInput.value = result.seconds;
                    }
                } else {
                    if (dateHelperOutputEl) dateHelperOutputEl.textContent = result.detail || 'Failed to parse offset';
                    showToast(result.detail || 'Offset failed', true);
                }
            } catch (err) {
                if (dateHelperOutputEl) dateHelperOutputEl.textContent = err.message;
                showToast('Offset failed: ' + err.message, true);
            }
        }

        document.getElementById('btn-save-variable').addEventListener('click', () => {
            const name = (document.getElementById('var-name').value || '').trim();
            const type = document.getElementById('var-type').value;
            if (!name) {
                showToast('Variable name required', true);
                return;
            }
            const params = {};
            document.querySelectorAll('#variable-params [data-param]').forEach(input => {
                const key = input.dataset.param;
                const dataType = input.dataset.type;
                if (dataType === 'list') {
                    params[key] = input.value.split('\n').map(line => line.trim()).filter(Boolean);
                } else if (dataType === 'number') {
                    const parsed = parseInt(input.value, 10);
                    params[key] = Number.isNaN(parsed) ? 0 : parsed;
                } else if (dataType === 'datetime') {
                    params[key] = input.value;
                } else {
                    params[key] = input.value.trim();
                }
            });
            const variable = { name, type, params };
            if (snippetState.modalMode === 'edit' && typeof snippetState.editingVarIndex === 'number') {
                snippetState.vars.splice(snippetState.editingVarIndex, 1, variable);
            } else {
                snippetState.vars.push(variable);
            }
            renderVariableList();
            closeVariableModal();
        });

        document.querySelectorAll('[data-shell-template]').forEach(btn => {
            btn.addEventListener('click', () => insertShellTemplate(btn.dataset.shellTemplate || ''));
        });
        document.getElementById('btn-test-shell')?.addEventListener('click', testShellCommand);
        document.querySelectorAll('[data-date-offset]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (dateOffsetExpressionInput) {
                    dateOffsetExpressionInput.value = btn.dataset.dateOffset || '';
                }
                applyDateOffset();
            });
        });
        document.getElementById('btn-apply-date-offset')?.addEventListener('click', applyDateOffset);

        async function saveSnippet() {
            if (!isWebview()) return;
            const trigger = (document.getElementById('snippet-trigger').value || '').trim();
            const replace = (document.getElementById('snippet-replace').value || '').replace(/\r\n/g, '\n');
            if (!trigger || !replace.trim()) {
                showToast('Trigger and replacement are required', true);
                return;
            }
            let delayValue = null;
            if (snippetDelayInput && snippetDelayInput.value !== '') {
                const parsed = Number(snippetDelayInput.value);
                if (!Number.isNaN(parsed)) {
                    delayValue = parsed;
                }
            }
            const payload = {
                trigger,
                replace,
                word: document.getElementById('snippet-word').checked,
                propagate_case: document.getElementById('snippet-propagate-case').checked,
                left_word: snippetLeftWordInput ? snippetLeftWordInput.checked : false,
                right_word: snippetRightWordInput ? snippetRightWordInput.checked : false,
                vars: snippetState.vars,
                label: snippetLabelInput ? snippetLabelInput.value.trim() : '',
                enabled: snippetEnabledInput ? snippetEnabledInput.checked : true,
                backend: snippetBackendSelect ? snippetBackendSelect.value : '',
                delay: delayValue,
                uppercase_style: snippetUppercaseStyleSelect ? snippetUppercaseStyleSelect.value : '',
                image_path: snippetImagePathInput ? snippetImagePathInput.value.trim() : ''
            };
            try {
                let result;
                if (snippetState.currentTrigger) {
                    result = await window.pywebview.api.update_snippet(snippetState.currentTrigger, payload);
                } else {
                    result = await window.pywebview.api.create_snippet(payload);
                }
                if (result.status === 'success') {
                    snippetState.currentTrigger = trigger;
                    document.getElementById('snippet-status').textContent = result.detail;
                    showToast(result.detail || 'Snippet saved');
                    await loadSnippetList();
                    await loadGlobalVars();
                } else {
                    showToast(result.detail, true);
                }
            } catch (err) {
                showToast('Failed to save snippet: ' + err.message, true);
            }
        }

        async function deleteSnippet() {
            if (!isWebview() || !snippetState.currentTrigger) {
                showToast('Select a snippet first', true);
                return;
            }
            if (!confirm(`Delete snippet ${snippetState.currentTrigger}?`)) return;
            try {
                const result = await window.pywebview.api.delete_snippet(snippetState.currentTrigger);
                if (result.status === 'success') {
                    showToast(result.detail);
                    resetSnippetForm();
                    await loadSnippetList();
                    await loadGlobalVars();
                } else {
                    showToast(result.detail, true);
                }
            } catch (err) {
                showToast('Failed to delete snippet: ' + err.message, true);
            }
        }

        async function browseImagePath() {
            if (!isWebview()) {
                showToast('File browser only available in desktop app', true);
                return;
            }
            try {
                const result = await window.pywebview.api.pick_path_dialog('Select an image file', false);
                if (result.status === 'success' && result.path) {
                    const imagePathInput = document.getElementById('snippet-image-path');
                    if (imagePathInput) {
                        imagePathInput.value = result.path;
                        updateImagePreview();
                    }
                }
            } catch (err) {
                showToast('Failed to open file browser: ' + err.message, true);
            }
        }

        function clearImagePath() {
            if (!snippetImagePathInput) return;
            snippetImagePathInput.value = '';
            updateImagePreview(true);
        }

        async function validateImagePath() {
            await updateImagePreview(false);
        }

        function scheduleImagePreviewUpdate() {
            if (!snippetImagePreviewEl) return;
            clearTimeout(imagePreviewDebounce);
            imagePreviewDebounce = setTimeout(() => updateImagePreview(true), 600);
        }

        async function updateImagePreview(auto = false) {
            if (!snippetImagePreviewEl) return;
            const path = (snippetImagePathInput?.value || '').trim();
            if (!path) {
                snippetImagePreviewEl.innerHTML = '<span>Drop an image or click Test to preview.</span>';
                return;
            }
            if (!isWebview()) {
                snippetImagePreviewEl.innerHTML = `<span style="color:#8b949e;">Preview unavailable outside the desktop app.</span>`;
                return;
            }
            snippetImagePreviewEl.innerHTML = '<span>Loading preview...</span>';
            try {
                const result = await window.pywebview.api.get_image_preview(path);
                if (result.status === 'success' && result.data) {
                    snippetImagePreviewEl.innerHTML = `<img src="${result.data}" alt="Image preview"><span style="color:#8b949e;">${escapeHtml(path)}</span>`;
                } else {
                    snippetImagePreviewEl.innerHTML = `<span style="color:#f85149;">${escapeHtml(result.detail || 'Preview failed')}</span>`;
                    if (!auto) showToast(result.detail || 'Image preview failed', true);
                }
            } catch (err) {
                snippetImagePreviewEl.innerHTML = `<span style="color:#f85149;">${escapeHtml(err.message)}</span>`;
                if (!auto) showToast('Image preview failed: ' + err.message, true);
            }
        }

        function handleImageDragOver(event) {
            event.preventDefault();
            snippetImagePreviewEl?.classList.add('drop-target');
        }

        function handleImageDragLeave(event) {
            event.preventDefault();
            snippetImagePreviewEl?.classList.remove('drop-target');
        }

        function handleImageDrop(event) {
            event.preventDefault();
            snippetImagePreviewEl?.classList.remove('drop-target');
            const file = event.dataTransfer?.files?.[0];
            if (!file) return;
            if (file.path && snippetImagePathInput) {
                snippetImagePathInput.value = file.path;
                updateImagePreview();
                showToast('Image path updated from drop');
            } else {
                const reader = new FileReader();
                reader.onload = () => {
                    snippetImagePreviewEl.innerHTML = `<img src="${reader.result}" alt="Image preview"><span style="color:#8b949e;">${escapeHtml(file.name)} (preview only)</span>`;
                };
                reader.readAsDataURL(file);
                showToast('Preview generated, but the file path is not accessible in this environment.', true);
            }
        }

        const TEMPLATES = [
            {name: 'Email Signature', trigger: ':sig', replace: 'Best regards,\n{{name}}\n{{title}}\n{{email}}'},
            {name: 'Meeting Notes', trigger: ':meeting', replace: '# Meeting Notes - {{date}}\n\n## Attendees\n- \n\n## Topics\n- \n\n## Action Items\n- '},
            {name: 'Code Comment Block', trigger: ':comment', replace: '/*\n * TODO: \n * @author {{name}}\n * @date {{date}}\n */'},
            {name: 'Current Date', trigger: ':today', replace: '{{date}}', vars: [{name: 'date', type: 'date', params: {format: '%Y-%m-%d'}}]},
            {name: 'Greeting', trigger: ':hi', replace: 'Hello {{name}},\n\n'},
        ];

        document.getElementById('btn-from-template')?.addEventListener('click', () => {
            const choice = prompt('Templates:\n' + TEMPLATES.map((t,i) => `${i+1}. ${t.name}`).join('\n') + '\n\nEnter number:');
            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < TEMPLATES.length) {
                const tmpl = TEMPLATES[idx];
                resetSnippetForm();
                document.getElementById('snippet-trigger').value = tmpl.trigger;
                document.getElementById('snippet-replace').value = tmpl.replace;
                if (tmpl.vars) snippetState.variables = tmpl.vars;
                showToast('Template applied: ' + tmpl.name);
            }
        });

        document.getElementById('btn-save-snippet').addEventListener('click', saveSnippet);
        document.getElementById('btn-delete-snippet').addEventListener('click', deleteSnippet);
        document.getElementById('btn-refresh-snippets').addEventListener('click', () => loadSnippetList(true));
        document.getElementById('btn-refresh-snippet-library')?.addEventListener('click', () => loadSnippetList(true));
        document.getElementById('snippetsense-save-settings')?.addEventListener('click', saveSnippetSenseSettings);
        document.getElementById('snippetsense-refresh-suggestions')?.addEventListener('click', () => refreshSnippetSenseSuggestions(true));
        document.getElementById('snippetsense-suggestions')?.addEventListener('click', (event) => {
            const action = event.target.dataset.suggestionAction;
            if (!action) return;
            const id = event.target.dataset.suggestionId;
            handleSnippetSenseDecision(id, action);
        });
        document.getElementById('snippetsense-toast-container')?.addEventListener('click', (event) => {
            const action = event.target.dataset.suggestionAction;
            if (!action) return;
            const id = event.target.dataset.suggestionId;
            const toast = event.target.closest('.snippetsense-toast');
            if (toast && toast.parentElement) {
                toast.parentElement.removeChild(toast);
                snippetSenseState.toastIds.delete(id);
            }
            handleSnippetSenseDecision(id, action);
        });

        async function loadVariableTypes() {
            if (!isWebview()) return;
            try {
                const types = await window.pywebview.api.get_variable_types();
                snippetState.variableTypes = types;
                variableTypeGrid.innerHTML = types.map(t => `
                    <div class="variable-type-card" data-type="${t.type}">
                        <h4>${escapeHtml(t.label)} <span>${escapeHtml(t.icon || '')}</span></h4>
                        <p style="margin-bottom:6px; color:#8b949e;">${escapeHtml(t.description || '')}</p>
                        <div style="font-size:11px; color:#6e7681;">Params: ${t.params.length ? t.params.join(', ') : 'none'}</div>
                        <button class="btn small secondary" data-type="${t.type}">Use Template</button>
                    </div>
                `).join('');
            } catch (err) {
                showToast('Failed to load variable types: ' + err.message, true);
            }
        }

        variableTypeGrid.addEventListener('click', event => {
            const dataType = event.target.dataset.type || event.target.closest('.variable-type-card')?.dataset.type;
            if (!dataType) return;
            openVariableModal('add', null, dataType);
        });

        async function loadGlobalVars() {
            if (!isWebview()) return;
            try {
                const globalVars = await window.pywebview.api.list_snippet_variables();
                snippetState.globalVars = globalVars;
                if (!globalVars.length) {
                    globalVarsEl.innerHTML = '<p style="color:#8b949e; font-size:13px;">No global variables detected.</p>';
                    return;
                }
                globalVarsEl.innerHTML = globalVars.map((variable, index) => `
                    <div class="global-var-card" data-name="${escapeHtml(variable.name || '')}" data-index="${index}">
                        <div>
                            <div style="font-weight:600;">{{${escapeHtml(variable.name || '')}}}</div>
                            <div style="font-size:11px; color:#8b949e;">${escapeHtml(variable.type || '')} • ${escapeHtml(variable.source_snippet || '')}</div>
                        </div>
                        <div class="variable-actions">
                            <button class="btn small secondary" data-action="insert-global" data-index="${index}">Insert</button>
                            <button class="btn small" data-action="open-snippet" data-index="${index}">Open Snippet</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                showToast('Failed to load global vars: ' + err.message, true);
            }
        }

        globalVarsEl.addEventListener('click', event => {
            const action = event.target.dataset.action;
            if (!action) return;
            const index = Number(event.target.dataset.index);
            const variable = snippetState.globalVars[index];
            if (!variable) return;
            if (action === 'insert-global' && variable.name) {
                switchView('snippet');
                insertVariableAtCursor(variable.name);
            } else if (action === 'open-snippet' && variable.source_snippet) {
                selectSnippet(variable.source_snippet);
                switchView('snippet');
            }
        });

        let bootstrapped = false;
        let refreshInterval = null;
        let logRefreshInterval = null;
        let diagnosticRefreshInterval = null;
        const DASHBOARD_REFRESH_INTERVAL = 5000;
        const LOG_REFRESH_INTERVAL = 15000;
        const DIAGNOSTIC_REFRESH_INTERVAL = 45000;
        const POST_BOOT_REFRESH_DELAY = 800;

        async function bootstrap() {
            try {
                await waitForBackendReady();
                await loadDashboard();
                await refreshAncillaryData({silent: true});
                await loadSnippetSenseState();
                if (!bootstrapped) {
                    bootstrapped = true;
                    refreshInterval = setInterval(loadDashboard, DASHBOARD_REFRESH_INTERVAL);
                    logRefreshInterval = setInterval(() => {
                        loadLogs({silent: true}).catch(err => console.error('Auto log refresh failed', err));
                    }, LOG_REFRESH_INTERVAL);
                    diagnosticRefreshInterval = setInterval(() => {
                        runDoctorDiagnostics(true).catch(err => console.error('Auto diagnostics failed', err));
                    }, DIAGNOSTIC_REFRESH_INTERVAL);
                    setTimeout(() => {
                        refreshAll().catch(err => console.error('Post-bootstrap refresh failed', err));
                    }, POST_BOOT_REFRESH_DELAY);
                    console.log('Dashboard loaded and refresh intervals set');
                }
            } catch (err) {
                console.error('Bootstrap failed:', err);
                const statusEl = document.getElementById('status-text');
                if (statusEl) {
                    statusEl.textContent = 'Waiting for Espanso service...';
                }
                setTimeout(bootstrap, 1000);
            }
        }

        // Theme toggle
        const themeToggleBtn = document.getElementById('theme-toggle');
        let currentTheme = 'dark';

        const persistTheme = (theme) => {
            try {
                localStorage.setItem('espanso-theme', theme);
            } catch (e) {
                console.warn('localStorage not available:', e);
            }
        };

        const updateThemeToggleLabel = () => {
            if (!themeToggleBtn) return;
            const nextThemeLabel = currentTheme === 'light' ? 'Switch to Dark Theme' : 'Switch to Light Theme';
            themeToggleBtn.textContent = nextThemeLabel;
            themeToggleBtn.setAttribute('title', nextThemeLabel);
            themeToggleBtn.setAttribute('aria-label', nextThemeLabel);
            themeToggleBtn.setAttribute('aria-pressed', currentTheme === 'light' ? 'true' : 'false');
        };

        const applyTheme = (theme) => {
            const normalized = theme === 'light' ? 'light' : 'dark';
            const isLight = normalized === 'light';
            document.body.classList.toggle('light-theme', isLight);
            document.body.dataset.theme = normalized;
            currentTheme = normalized;
            updateThemeToggleLabel();
            persistTheme(normalized);
        };

        const detectStoredTheme = () => {
            try {
                return localStorage.getItem('espanso-theme') || document.body.dataset.theme || 'dark';
            } catch (e) {
                console.warn('localStorage not available:', e);
                return document.body.dataset.theme || 'dark';
            }
        };

        applyTheme(detectStoredTheme());
        themeToggleBtn?.addEventListener('click', () => {
            const nextTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(nextTheme);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+K or Cmd+K: Focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchBox = document.getElementById('snippet-search-box');
                if (searchBox && !searchBox.closest('.panel').classList.contains('hidden')) {
                    searchBox.focus();
                    searchBox.select();
                }
            }
            // Ctrl+S or Cmd+S: Save snippet
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const saveBtn = document.getElementById('btn-save-snippet');
                if (saveBtn && !saveBtn.closest('.panel').classList.contains('hidden')) {
                    saveBtn.click();
                }
            }
            // Ctrl+N or Cmd+N: New snippet
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                if (currentPanel === 'snippet-ide-panel') {
                    resetSnippetForm();
                }
            }
            // Escape: Close modals or clear selection
            if (e.key === 'Escape') {
                const modal = document.getElementById('variable-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                } else if (currentPanel === 'snippet-ide-panel') {
                    resetSnippetForm();
                }
            }
        });

        // Wait for pywebview to be fully ready
        document.addEventListener('pywebviewready', () => {
            console.log('PyWebView ready event fired');
            bootstrap();
        });

        window.addEventListener('load', () => {
            // Always attempt bootstrap; it will keep retrying until the API becomes available.
            setTimeout(bootstrap, 100);
        });
    </script>

    <!--
    CHANGELOG
    2025-02-14 Codex
    - Rebuilt the UI with a Snippet & Variable IDE, modal variable editor, and global variable library.
    2025-11-14 Codex
    - Added dedicated Paths & Config Explorer plus standalone Snippet/Variable Library views with live replacement previews.
    2025-11-14 Codex
    - Moved the variable toolkit into the IDE, wired library cards to open snippets, and added live cursor preview helpers.
    2025-11-15 Codex
    - Fixed bootstrap race condition: added retry logic and proper pywebview API readiness checks
    - Improved dashboard loading with defensive null checks and better error handling
    - Added automatic data loading on startup to eliminate manual "refresh required" step
    - Enhanced console logging for debugging initialization issues
    2025-11-14 Codex
    - Implemented Phase 5 snippet fields (label, enable/disable, backend, delay, boundaries, uppercase, image) and rebuilt the snippet library with query/label/file/flag filters backed by the new search API.
    2025-11-17 Codex
    - Delivered Phase 13 polish: Quick Insert palette, checkbox hit area fix, pervasive tooltips, media previews with drag-drop, and shell/date/form helpers.
    2025-11-17 Codex
    - Added automatic data refresh (logs, diagnostics, library/config), in-app help, and the SnippetSense settings/suggestion workflow with toast prompts.
    2025-11-17 Codex
    - Automated post-bootstrap refreshes, scheduled log/diagnostic polling, SnippetSense IDE hydration, and resilient theme toggling with ARIA/label updates.
    2025-11-17 Codex
    - Rebuilt global variable editor state so it writes Espanso-compliant `type` fields, filters blanks, and prevents YAML corruption.
    2025-11-17 Codex
    - Added storage controls to relocate Espanso config folders and EspansoGUI backup directories with migration + UI feedback.
    2025-11-17 Codex
    - Added backend readiness polling, fixed match testing output, and restyled the Snippet IDE/dashboard panels for better spacing and theme parity.
-->
</body>
</html>
